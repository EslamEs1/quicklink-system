{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Page Title -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-users-cog me-2 text-primary"></i>
                    إدارة المستخدمين والصلاحيات
                </h2>
                <div>
                    <a href="{% url 'accounts:permissions' %}" class="btn btn-warning me-2">
                        <i class="fas fa-user-shield me-1"></i>
                        إدارة الصلاحيات
                    </a>
                    <button class="btn btn-primary" onclick="addNewUser()">
                        <i class="fas fa-user-plus me-1"></i>
                        إضافة مستخدم جديد
                    </button>
                </div>
            </div>

            <!-- Smart Permissions Notice -->
            <div class="alert alert-info mb-4">
                <i class="fas fa-shield-alt me-2"></i>
                <strong>الصلاحيات الذكية:</strong> الموظف يرى فقط العملاء الذين لديهم طلبات مفتوحة معه. المدير يرى جميع الملفات. المشرف الأعلى يملك صلاحية إعداد القوالب والسياسات.
            </div>

            <!-- Search and Filters -->
            <div class="card shadow-custom mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">البحث في المستخدمين</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" placeholder="البحث بالاسم أو البريد الإلكتروني" id="userSearchInput">
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">فلترة حسب الدور</label>
                            <select class="form-control" id="roleFilter">
                                <option value="all">جميع الأدوار</option>
                                <option value="admin">مشرف أعلى (Admin)</option>
                                <option value="manager">مدير النظام (Manager)</option>
                                <option value="reviewer">مراجع/مدقق (Reviewer)</option>
                                <option value="intake">جامع البيانات (Intake User)</option>
                                <option value="viewer">مشاهد (Viewer)</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">فلترة حسب الحالة</label>
                            <select class="form-control" id="statusFilter">
                                <option value="all">جميع الحالات</option>
                                <option value="active">نشط</option>
                                <option value="inactive">غير نشط</option>
                                <option value="suspended">موقوف</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button class="btn btn-outline-primary" onclick="clearUserFilters()">
                                    <i class="fas fa-times me-1"></i>
                                    مسح الفلاتر
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Stats -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-users icon-large text-primary"></i>
                            <div class="stats-number">{{ total_users|default:0 }}</div>
                            <div class="stats-label">إجمالي المستخدمين</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-user-check icon-large text-success"></i>
                            <div class="stats-number">{{ active_users|default:0 }}</div>
                            <div class="stats-label">مستخدمين نشطين</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-user-shield icon-large text-warning"></i>
                            <div class="stats-number">{{ admin_users|default:0 }}</div>
                            <div class="stats-label">مدراء النظام</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-clock icon-large text-info"></i>
                            <div class="stats-number">{{ online_users|default:0 }}</div>
                            <div class="stats-label">متصلين الآن</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card shadow-custom">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        قائمة المستخدمين
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportUsersToExcel()">
                            <i class="fas fa-file-excel me-1"></i>
                            تصدير Excel
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sendBulkEmail()">
                            <i class="fas fa-envelope me-1"></i>
                            رسالة جماعية
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead>
                                <tr>
                                    <th>المستخدم</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>الدور</th>
                                    <th>الحالة</th>
                                    <th>آخر نشاط</th>
                                    <th>تاريخ الإنضمام</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-2">
                                                <i class="fas fa-user-shield"></i>
                                            </div>
                                            <div>
                                                <strong>أحمد محمد</strong>
                                                <br>
                                                <small class="text-muted">مدير النظام</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>ahmed@quicklink.ae</td>
                                    <td><span class="badge bg-danger">مدير النظام</span></td>
                                    <td>
                                        <span class="status-indicator status-online"></span>
                                        <span class="badge bg-success">نشط</span>
                                    </td>
                                    <td>منذ 5 دقائق</td>
                                    <td>15 يناير 2024</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-action btn-view" onclick="viewUserProfile(1)" title="عرض الملف">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-action btn-edit" onclick="editUser(1)" title="تعديل">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-action btn-info" onclick="viewUserActivity(1)" title="النشاط">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button class="btn btn-action btn-warning" onclick="resetPassword(1)" title="إعادة تعيين كلمة المرور">
                                                <i class="fas fa-key"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-2 bg-primary">
                                                <i class="fas fa-user-tie"></i>
                                            </div>
                                            <div>
                                                <strong>فاطمة السعد</strong>
                                                <br>
                                                <small class="text-muted">مديرة</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>fatima@quicklink.ae</td>
                                    <td><span class="badge bg-warning">مديرة</span></td>
                                    <td>
                                        <span class="status-indicator status-online"></span>
                                        <span class="badge bg-success">نشط</span>
                                    </td>
                                    <td>منذ 15 دقيقة</td>
                                    <td>10 يناير 2024</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-action btn-view" onclick="viewUserProfile(2)" title="عرض الملف">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-action btn-edit" onclick="editUser(2)" title="تعديل">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-action btn-info" onclick="viewUserActivity(2)" title="النشاط">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button class="btn btn-action btn-warning" onclick="resetPassword(2)" title="إعادة تعيين كلمة المرور">
                                                <i class="fas fa-key"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-2 bg-success">
                                                <i class="fas fa-user-check"></i>
                                            </div>
                                            <div>
                                                <strong>محمد الأحمد</strong>
                                                <br>
                                                <small class="text-muted">مراجع</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>mohammed@quicklink.ae</td>
                                    <td><span class="badge bg-info">مراجع</span></td>
                                    <td>
                                        <span class="status-indicator status-offline"></span>
                                        <span class="badge bg-success">نشط</span>
                                    </td>
                                    <td>منذ ساعة</td>
                                    <td>5 يناير 2024</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-action btn-view" onclick="viewUserProfile(3)" title="عرض الملف">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-action btn-edit" onclick="editUser(3)" title="تعديل">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-action btn-info" onclick="viewUserActivity(3)" title="النشاط">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button class="btn btn-action btn-warning" onclick="resetPassword(3)" title="إعادة تعيين كلمة المرور">
                                                <i class="fas fa-key"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-2 bg-secondary">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div>
                                                <strong>سارة خالد</strong>
                                                <br>
                                                <small class="text-muted">مستخدمة</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>sara@quicklink.ae</td>
                                    <td><span class="badge bg-secondary">مستخدمة</span></td>
                                    <td>
                                        <span class="status-indicator status-away"></span>
                                        <span class="badge bg-warning">موقوفة</span>
                                    </td>
                                    <td>منذ 3 أيام</td>
                                    <td>1 يناير 2024</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-action btn-view" onclick="viewUserProfile(4)" title="عرض الملف">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-action btn-edit" onclick="editUser(4)" title="تعديل">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-action btn-success" onclick="activateUser(4)" title="تفعيل">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-action btn-delete" onclick="deleteUser(4)" title="حذف">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Roles and Permissions -->
            <div class="row mt-4">
                <div class="col-lg-6 mb-4">
                    <div class="card shadow-custom">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-user-tag me-2"></i>
                                الأدوار والصلاحيات
                            </h5>
                            <button class="btn btn-outline-primary btn-sm" onclick="manageRoles()">
                                <i class="fas fa-cog me-1"></i>
                                إدارة
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="role-item">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <h6 class="mb-0">مدير النظام</h6>
                                        <small class="text-muted">صلاحيات كاملة للنظام</small>
                                    </div>
                                    <span class="badge bg-danger">3 مستخدمين</span>
                                </div>
                                <div class="permissions-list">
                                    <span class="badge bg-light text-dark me-1 mb-1">إدارة المستخدمين</span>
                                    <span class="badge bg-light text-dark me-1 mb-1">إدارة الإعدادات</span>
                                    <span class="badge bg-light text-dark me-1 mb-1">عرض التقارير</span>
                                    <span class="badge bg-light text-dark me-1 mb-1">إدارة النسخ الاحتياطي</span>
                                </div>
                            </div>
                            <hr>
                            <div class="role-item">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <h6 class="mb-0">مدير</h6>
                                        <small class="text-muted">إدارة الطلبات والعملاء</small>
                                    </div>
                                    <span class="badge bg-warning">5 مستخدمين</span>
                                </div>
                                <div class="permissions-list">
                                    <span class="badge bg-light text-dark me-1 mb-1">إدارة الطلبات</span>
                                    <span class="badge bg-light text-dark me-1 mb-1">إدارة العملاء</span>
                                    <span class="badge bg-light text-dark me-1 mb-1">عرض التقارير</span>
                                </div>
                            </div>
                            <hr>
                            <div class="role-item">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <h6 class="mb-0">مراجع</h6>
                                        <small class="text-muted">مراجعة والموافقة على الطلبات</small>
                                    </div>
                                    <span class="badge bg-info">8 مستخدمين</span>
                                </div>
                                <div class="permissions-list">
                                    <span class="badge bg-light text-dark me-1 mb-1">مراجعة الطلبات</span>
                                    <span class="badge bg-light text-dark me-1 mb-1">الموافقة/الرفض</span>
                                    <span class="badge bg-light text-dark me-1 mb-1">عرض العملاء</span>
                                </div>
                            </div>
                            <hr>
                            <div class="role-item">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <h6 class="mb-0">مستخدم</h6>
                                        <small class="text-muted">إنشاء وعرض الطلبات فقط</small>
                                    </div>
                                    <span class="badge bg-secondary">8 مستخدمين</span>
                                </div>
                                <div class="permissions-list">
                                    <span class="badge bg-light text-dark me-1 mb-1">إنشاء طلب</span>
                                    <span class="badge bg-light text-dark me-1 mb-1">عرض الطلبات</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <div class="card shadow-custom">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>
                                إحصائيات النشاط
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="activity-stat mb-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>تسجيلات الدخول اليوم</span>
                                    <strong>45</strong>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-primary" style="width: 75%"></div>
                                </div>
                            </div>
                            <div class="activity-stat mb-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>الطلبات المعالجة اليوم</span>
                                    <strong>32</strong>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: 64%"></div>
                                </div>
                            </div>
                            <div class="activity-stat mb-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>متوسط وقت الاستجابة</span>
                                    <strong>2.5 دقيقة</strong>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-info" style="width: 85%"></div>
                                </div>
                            </div>
                            <div class="activity-stat">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>معدل الإنتاجية</span>
                                    <strong>92%</strong>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" style="width: 92%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            {% include 'pagination.html' %}
{% endblock content %}
