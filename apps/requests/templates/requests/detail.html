{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Include messages component -->
{% include 'message.html' %}
<!-- رأس الصفحة -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="page-title mb-2">
                        <i class="fas fa-file-alt text-primary me-2"></i>
                        تفاصيل الطلب
                    </h2>
                    <p class="page-subtitle text-muted">عرض كامل تفاصيل الطلب والمستندات والإجراءات</p>
                </div>
                <div>
                    <a href="{% url 'requests:list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-right me-1"></i>
                        رجوع للطلبات
                    </a>
                </div>
            </div>

            <!-- رقم الطلب والحالة -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-2">
                                <i class="fas fa-hashtag text-primary me-2"></i>
                                رقم الطلب: <strong>{{ request.reference_number }}</strong>
                            </h4>
                            <p class="text-muted mb-0">
                                <i class="fas fa-calendar me-2"></i>
                                تاريخ الإنشاء: <span>{{ request.created_at|date:"d يناير Y - h:i A" }}</span>
                            </p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <span class="badge 
                                {% if request.status == 'new' %}bg-primary
                                {% elif request.status == 'in_review' %}bg-warning
                                {% elif request.status == 'approved' %}bg-success
                                {% elif request.status == 'completed' or request.status == 'paid' %}bg-info
                                {% elif request.status == 'rejected' or request.status == 'cancelled' %}bg-danger
                                {% else %}bg-secondary{% endif %} p-2 fs-6">
                                <i class="fas fa-
                                    {% if request.status == 'new' %}file
                                    {% elif request.status == 'in_review' %}clock
                                    {% elif request.status == 'approved' or request.status == 'completed' %}check-circle
                                    {% elif request.status == 'paid' %}money-bill
                                    {% else %}times-circle{% endif %} me-1"></i>
                                {{ request.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- بيانات العميل -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user text-primary me-2"></i>
                        بيانات العميل
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">الاسم الكامل</label>
                            <p class="fw-bold mb-0">{{ request.customer.full_name }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">رقم الهوية الإماراتية</label>
                            <p class="fw-bold mb-0">{{ request.customer.masked_emirates_id|default:"غير محدد" }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">رقم الجوال</label>
                            <p class="mb-0">
                                <a href="{% url 'chat:room' %}?customer_id={{ request.customer.id }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-phone me-1"></i>
                                    {{ request.customer.masked_phone }}
                                </a>
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">البريد الإلكتروني</label>
                            <p class="fw-bold mb-0">{{ request.customer.email|default:"غير محدد" }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">تاريخ الميلاد</label>
                            <p class="fw-bold mb-0">{{ request.customer.date_of_birth|date:"d يناير Y"|default:"غير محدد" }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">الجنسية</label>
                            <p class="fw-bold mb-0">{{ request.customer.nationality|default:"غير محدد" }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- بيانات الطلب -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-primary me-2"></i>
                        بيانات الطلب
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">نوع الخدمة</label>
                            <p class="fw-bold mb-0">
                                {% if request.request_type %}
                                    {{ request.request_type.name_arabic }}
                                {% else %}
                                    غير محدد
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">القالب المستخدم</label>
                            <p class="fw-bold mb-0">
                                {% if request.template %}
                                    {{ request.template.name }} - الإصدار {{ request.template.version }}
                                {% else %}
                                    غير محدد
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">المستخدم المنشئ</label>
                            <p class="fw-bold mb-0">
                                <i class="fas fa-user-circle me-1"></i>
                                {% if request.created_by %}
                                    {{ request.created_by.get_full_name|default:request.created_by.username }}
                                {% else %}
                                    النظام
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">الأولوية</label>
                            <p class="mb-0">
                                <span class="badge 
                                    {% if request.priority == 'urgent' %}bg-danger
                                    {% elif request.priority == 'high' %}bg-warning
                                    {% else %}bg-secondary{% endif %}">
                                    {{ request.get_priority_display }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">المسند إلى</label>
                            <p class="fw-bold mb-0">
                                {% if request.assigned_to %}
                                    <i class="fas fa-user-tie me-1 text-primary"></i>
                                    {{ request.assigned_to.get_full_name|default:request.assigned_to.username }}
                                {% else %}
                                    <span class="text-muted">غير مخصص</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">تاريخ التقديم</label>
                            <p class="fw-bold mb-0">{{ request.submission_date|date:"d يناير Y"|default:"غير محدد" }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">تاريخ الاستحقاق</label>
                            <p class="mb-0">
                                {% if request.due_date %}
                                    <strong class="{% if request.is_overdue %}text-danger{% else %}text-success{% endif %}">
                                        {{ request.due_date|date:"d يناير Y" }}
                                        {% if request.is_overdue %}
                                            <i class="fas fa-exclamation-triangle text-danger ms-1" title="متأخر"></i>
                                        {% endif %}
                                    </strong>
                                {% else %}
                                    <span class="text-muted">غير محدد</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">حالة الدفع</label>
                            <p class="mb-0">
                                {% if payment %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        {{ payment.get_status_display }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times-circle me-1"></i>
                                        لم يتم الدفع
                                    </span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted mb-1">المبلغ المطلوب</label>
                            <p class="fw-bold mb-0 text-success">{{ request.total_amount|default:"0" }} درهم</p>
                        </div>
                        <!-- ملاحظات الطلب - تظهر دائماً -->
                        <div class="col-md-12 mb-3">
                            <label class="text-muted mb-1">ملاحظات الطلب</label>
                            {% if request.notes %}
                            <div class="alert alert-info mb-0" style="display: block !important;">
                                <i class="fas fa-sticky-note me-2"></i>
                                {{ request.notes }}
                            </div>
                            {% else %}
                            <div class="alert alert-light mb-0" style="display: block !important;">
                                <i class="fas fa-info-circle me-2"></i>
                                لا توجد ملاحظات
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- حالة الموافقة - تظهر دائماً إذا كانت موجودة -->
                        {% if request.approved_by %}
                        <div class="col-md-12 mb-3">
                            <div class="alert alert-success mb-0" style="display: block !important;">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>تمت الموافقة:</strong> بواسطة {{ request.approved_by.get_full_name|default:request.approved_by.username }} 
                                في {{ request.approved_at|date:"d يناير Y - h:i A" }}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- حالة الرفض - تظهر دائماً إذا كانت موجودة -->
                        {% if request.rejected_by %}
                        <div class="col-md-12 mb-3">
                            <div class="alert alert-danger mb-0" style="display: block !important;">
                                <i class="fas fa-times-circle me-2"></i>
                                <strong>تم الرفض:</strong> بواسطة {{ request.rejected_by.get_full_name|default:request.rejected_by.username }} 
                                في {{ request.rejected_at|date:"d يناير Y - h:i A" }}
                                <br>
                                <strong>السبب:</strong> {{ request.rejection_reason|default:"لم يذكر سبب" }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- المستندات المرفقة -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-paperclip text-primary me-2"></i>
                        المستندات المرفقة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-shield-alt me-2"></i>
                        <strong>حماية البيانات:</strong> المستندات مشفّرة ومحمية. يُمنع النسخ أو التحميل غير المصرح.
                    </div>
                    
                    {% if attachments %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>نوع المستند</th>
                                        <th>اسم الملف</th>
                                        <th>تاريخ الرفع</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attachment in attachments %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            <i class="fas fa-
                                                {% if 'id' in attachment.file_type or 'هوية' in attachment.description %}id-card
                                                {% elif 'pdf' in attachment.file_type %}file-pdf
                                                {% elif 'image' in attachment.file_type %}image
                                                {% else %}file{% endif %} text-primary me-1"></i>
                                            {{ attachment.description|default:"مستند" }}
                                        </td>
                                        <td>{{ attachment.file.name|default:"ملف" }}</td>
                                        <td>{{ attachment.uploaded_at|date:"d يناير Y - h:i A" }}</td>
                                        <td>
                                            {% if attachment.file %}
                                                <a href="{{ attachment.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i> عرض
                                                </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                            <p>لا توجد مستندات مرفقة</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- سجل التدقيق -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-primary me-2"></i>
                        سجل التدقيق والتعديلات
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>مهم:</strong> جميع التعديلات تُسجَّل تلقائيًا ولا يمكن حذفها.
                    </div>
                    
                    {% if audit_logs %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>التاريخ والوقت</th>
                                        <th>المستخدم</th>
                                        <th>الإجراء</th>
                                        <th>التفاصيل</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in audit_logs %}
                                    <tr>
                                        <td>{{ log.timestamp|date:"d يناير Y - h:i A" }}</td>
                                        <td>
                                            <i class="fas fa-{% if log.user %}user-circle{% else %}robot{% endif %} text-primary me-1"></i>
                                            {% if log.user %}
                                                {{ log.user.get_full_name|default:log.user.username }}
                                            {% else %}
                                                النظام
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge 
                                                {% if log.action == 'create' %}bg-success
                                                {% elif log.action == 'update' or log.action == 'edit' %}bg-warning
                                                {% elif log.action == 'delete' %}bg-danger
                                                {% else %}bg-info{% endif %}">
                                                {{ log.action|title }}
                                            </span>
                                        </td>
                                        <td>{{ log.description|default:"لا توجد تفاصيل" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-history fa-3x mb-3 d-block"></i>
                            <p>لا يوجد سجل تدقيق حتى الآن</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- الإجراءات -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs text-primary me-2"></i>
                        الإجراءات المتاحة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% if request.status == 'new' or request.status == 'in_review' %}
                        <div class="col-md-3 col-6">
                            <a href="{% url 'requests:edit' request.id %}" class="btn btn-primary w-100">
                                <i class="fas fa-edit me-1"></i>
                                تعديل الطلب
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if request.status == 'in_review' %}
                        <div class="col-md-3 col-6">
                            <form method="post" action="{% url 'requests:approve' request.id %}" style="display: inline;" class="w-100">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-check-circle me-1"></i>
                                    موافقة
                                </button>
                            </form>
                        </div>
                        <div class="col-md-3 col-6">
                            <form method="post" action="{% url 'requests:reject' request.id %}" style="display: inline;" class="w-100">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger w-100">
                                    <i class="fas fa-times-circle me-1"></i>
                                    رفض
                                </button>
                            </form>
                        </div>
                        {% endif %}
                        
                        {% if request.status == 'approved' or request.status == 'pending_payment' %}
                        <div class="col-md-3 col-6">
                            <a href="{% url 'payments:process' %}?request_id={{ request.id }}" class="btn btn-warning w-100">
                                <i class="fas fa-credit-card me-1"></i>
                                معالجة الدفع
                            </a>
                        </div>
                        {% endif %}
                        
                        <div class="col-md-3 col-6">
                            <button class="btn btn-info w-100" onclick="window.print()">
                                <i class="fas fa-print me-1"></i>
                                طباعة
                            </button>
                        </div>
                        <div class="col-md-3 col-6">
                            <a href="{% url 'requests:export_pdf' request.id %}" class="btn btn-secondary w-100">
                                <i class="fas fa-download me-1"></i>
                                تصدير PDF
                            </a>
                        </div>
                        <div class="col-md-3 col-6">
                            <a href="{% url 'chat:room' %}?customer_id={{ request.customer.id }}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-phone me-1"></i>
                                اتصال بالعميل
                            </a>
                        </div>
                        
                        {% if request.status == 'new' or request.status == 'in_review' or request.status == 'cancelled' %}
                        <div class="col-md-3 col-6">
                            <a href="{% url 'requests:delete' request.id %}" class="btn btn-outline-danger w-100">
                                <i class="fas fa-trash me-1"></i>
                                حذف الطلب
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
{% endblock content %}
