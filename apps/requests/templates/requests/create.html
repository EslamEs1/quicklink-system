{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Progress Steps -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-custom">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <div class="step-item active">
                                            <div class="step-number">1</div>
                                            <div class="step-title">بيانات العميل</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="step-item">
                                            <div class="step-number">2</div>
                                            <div class="step-title">اختيار القالب</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="step-item">
                                            <div class="step-number">3</div>
                                            <div class="step-title">مراجعة البيانات</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="step-item">
                                            <div class="step-number">4</div>
                                            <div class="step-title">الدفع والإرسال</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Form -->
                <form id="createRequestForm" method="post" action="{% url 'requests:create' %}" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <!-- Step 1: Customer Information -->
                    <div class="step-content" id="step1">
                        <div class="row">
                            <div class="col-lg-8">
                                <!-- اختيار: عميل موجود أو جديد -->
                                <div class="card shadow-custom mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-users me-2"></i>
                                            اختر طريقة إدخال بيانات العميل
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="customerOption" 
                                                           id="existingCustomer" value="existing" onchange="toggleCustomerForm()">
                                                    <label class="form-check-label" for="existingCustomer">
                                                        <i class="fas fa-user-check text-success me-1"></i>
                                                        <strong>اختيار عميل موجود</strong>
                                                    </label>
                                                </div>
                                                <small class="text-muted d-block mt-1">ملف العميل موجود مسبقاً في النظام</small>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="customerOption" 
                                                           id="newCustomer" value="new" checked onchange="toggleCustomerForm()">
                                                    <label class="form-check-label" for="newCustomer">
                                                        <i class="fas fa-user-plus text-primary me-1"></i>
                                                        <strong>إضافة عميل جديد</strong>
                                                    </label>
                                                </div>
                                                <small class="text-muted d-block mt-1">أول طلب للعميل - إنشاء ملف جديد</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- اختيار عميل موجود -->
                                <div class="card shadow-custom mb-4 d-none" id="existingCustomerSection">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-search me-2"></i>
                                            اختيار عميل من القائمة
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">البحث عن العميل <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control form-control-lg" id="customerSearch" 
                                                   placeholder="ابحث بالاسم أو رقم الهوية أو رقم الجوال...">
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                ابدأ الكتابة لعرض النتائج
                                            </div>
                                        </div>
                                        
                                        <div id="customerSearchResults" class="list-group">
                                            <!-- نتائج البحث ستظهر هنا -->
                                            {% if customers %}
                                                {% for customer in customers|slice:":10" %}
                                                <a href="#" class="list-group-item list-group-item-action" 
                                                   onclick="selectExistingCustomer({{ customer.id }}, '{{ customer.full_name }}', '{{ customer.masked_emirates_id }}', '{{ customer.phone }}', '{{ customer.email }}'); return false;">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <i class="fas fa-user text-primary me-2"></i>
                                                            <strong>{{ customer.full_name }}</strong>
                                                            <br>
                                                            <small class="text-muted">
                                                                <i class="fas fa-id-card me-1"></i>{{ customer.masked_emirates_id }}
                                                                <span class="mx-2">|</span>
                                                                <i class="fas fa-phone me-1"></i>{{ customer.masked_phone }}
                                                            </small>
                                                        </div>
                                                        <span class="badge bg-success">{{ customer.requests.count }} طلبات</span>
                                                    </div>
                                                </a>
                                                {% endfor %}
                                            {% else %}
                                                <div class="text-center text-muted py-3">
                                                    <i class="fas fa-search fa-2x mb-2 d-block"></i>
                                                    <p>ابحث عن عميل...</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="alert alert-success mt-3 d-none" id="selectedCustomerAlert">
                                            <i class="fas fa-check-circle me-2"></i>
                                            تم اختيار العميل: <strong id="selectedCustomerName"></strong>
                                        </div>
                                        <input type="hidden" name="existing_customer_id" id="existingCustomerId">
                                    </div>
                                </div>

                                <!-- نموذج عميل جديد -->
                                <div class="card shadow-custom" id="newCustomerSection">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-user me-2"></i>
                                            بيانات العميل الأساسية
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <!-- Reference Number -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الرقم المرجعي للطلب</label>
                                                <input type="text" class="form-control" id="referenceNumber" 
                                                       data-auto-reference readonly>
                                            </div>
                                            
                                            <!-- Request Date -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تاريخ الطلب</label>
                                                <input type="date" class="form-control" id="requestDate" name="request_date"
                                                       value="" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Customer Name -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الاسم الكامل للعميل <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="customerName" name="customerName"
                                                       placeholder="أدخل الاسم الكامل" required>
                                            </div>
                                            
                                            <!-- Confirm Name -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تأكيد الاسم <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="confirmName" name="confirmName"
                                                       placeholder="أعد كتابة الاسم للتأكيد" required>
                                                <div class="form-text text-danger" id="nameMatchError" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    الأسماء غير متطابقة!
                                                </div>
                                                <div class="form-text text-success" id="nameMatchSuccess" style="display: none;">
                                                    <i class="fas fa-check-circle"></i>
                                                    الأسماء متطابقة ✓
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Emirates ID -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">رقم الهوية الإماراتية <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="emiratesId" name="emiratesId"
                                                       placeholder="784-1990-1234567-8" maxlength="18" required>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    التنسيق: 784-YYYY-NNNNNNN-D (15 رقم + شرطات)
                                                </div>
                                                <div class="form-text text-danger" id="idFormatError" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    <strong>خطأ!</strong> يجب أن يكون: 784-YYYY-NNNNNNN-D
                                                    <br><small>مثال: 784-1990-1234567-8</small>
                                                </div>
                                                <div class="form-text text-success" id="idFormatSuccess" style="display: none;">
                                                    <i class="fas fa-check-circle"></i>
                                                    تنسيق صحيح ✓
                                                </div>
                                                <div class="form-text text-warning" id="idConflictWarning" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    تحذير: نفس الاسم مع هوية مختلفة!
                                                </div>
                                            </div>
                                            
                                            <!-- Date of Birth -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تاريخ الميلاد <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="dateOfBirth" name="date_of_birth" required>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    العمر يجب أن يكون 7 سنوات على الأقل
                                                </div>
                                                <div class="form-text text-danger" id="dobError" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    <span id="dobErrorMsg"></span>
                                                </div>
                                                <div class="form-text text-success" id="dobSuccess" style="display: none;">
                                                    <i class="fas fa-check-circle"></i>
                                                    العمر: <span id="ageDisplay"></span> سنة ✓
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Nationality -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الجنسية <span class="text-danger">*</span></label>
                                                <select class="form-control" id="nationality" name="nationality" required>
                                                    <option value="">اختر الجنسية</option>
                                                    <option value="emirati">إماراتي</option>
                                                    <option value="saudi">سعودي</option>
                                                    <option value="egyptian">مصري</option>
                                                    <option value="indian">هندي</option>
                                                    <option value="pakistani">باكستاني</option>
                                                    <option value="other">أخرى</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Mobile Number -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">رقم الجوال <span class="text-danger">*</span></label>
                                                <input type="tel" class="form-control" id="mobileNumber" name="mobileNumber"
                                                       placeholder="+971-XX-XXX-XXXX" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Email -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">البريد الإلكتروني</label>
                                                <input type="email" class="form-control" id="email" name="email"
                                                       placeholder="example@email.com">
                                            </div>
                                            
                                            <!-- Request Type -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">نوع الطلب <span class="text-danger">*</span></label>
                                                <select class="form-control" id="requestType" name="request_type_id" required>
                                                    <option value="">اختر نوع الطلب</option>
                                                    {% if request_types %}
                                                        {% regroup request_types by category as category_groups %}
                                                        {% for category in category_groups %}
                                                        <optgroup label="{{ category.grouper|title }}">
                                                            {% for type in category.list %}
                                                            <option value="{{ type.id }}" data-price="{{ type.default_price }}">
                                                                {{ type.name_arabic }} - {{ type.default_price }} درهم
                                                            </option>
                                                            {% endfor %}
                                                        </optgroup>
                                                        {% endfor %}
                                                    {% else %}
                                                        <option value="" disabled>لا توجد أنواع متاحة</option>
                                                    {% endif %}
                                                </select>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    اختر نوع الخدمة المطلوبة
                                                    {% if not request_types %}
                                                    <br>
                                                    <span class="text-danger">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                        لا توجد أنواع طلبات. يرجى إضافة أنواع من 
                                                        <a href="{% url 'requests:request_types_list' %}" class="text-danger">صفحة إدارة الأنواع</a>
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <!-- Priority -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الأولوية</label>
                                                <select class="form-control" id="priority" name="priority">
                                                    <option value="medium">متوسطة</option>
                                                    <option value="low">منخفضة</option>
                                                    <option value="high">عالية</option>
                                                    <option value="urgent">عاجلة</option>
                                                </select>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    الأولوية الافتراضية: متوسطة
                                                </div>
                                            </div>
                                            
                                            <!-- Due Date -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تاريخ الاستحقاق</label>
                                                <input type="date" class="form-control" id="dueDate" name="due_date">
                                                <div class="form-text">
                                                    <i class="fas fa-calendar me-1"></i>
                                                    الموعد النهائي لإنجاز الطلب (اختياري)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ID Upload Section -->
                            <div class="col-lg-4">
                                <div class="card shadow-custom" id="imageUploadCard">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-camera me-2"></i>
                                            صورة الهوية
                                        </h5>
                                    </div>
                                    <div class="card-body text-center">
                                        <div class="upload-area" id="uploadArea">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">اسحب وأفلت صورة الهوية هنا</p>
                                            <p class="text-muted small">أو انقر للاختيار</p>
                                            <input type="file" id="idImage" accept="image/*" class="d-none" name="id_image">
                                        </div>
                                        <div class="preview-area d-none" id="previewArea">
                                            <img id="imagePreview" class="img-fluid rounded mb-2" style="max-height: 200px;">
                                            <button type="button" class="btn btn-sm btn-danger" onclick="removeImage()">
                                                <i class="fas fa-trash me-1"></i>إزالة
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Validation Checklist - ثابت في جميع الخطوات -->
                                <div class="card shadow-custom mt-3" id="checklistCard">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-tasks me-2"></i>
                                            قائمة التحقق - الخطوة <span id="currentStepNum">1</span>
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Step 1 Checks -->
                                        <div id="step1Checks">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="checkName" disabled>
                                                <label class="form-check-label" for="checkName">
                                                    <small>✓ تطابق الأسماء</small>
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="checkId" disabled>
                                                <label class="form-check-label" for="checkId">
                                                    <small>✓ صحة رقم الهوية</small>
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="checkImage" disabled>
                                                <label class="form-check-label" for="checkImage">
                                                    <small>✓ رفع صورة الهوية</small>
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Step 2 Checks -->
                                        <div id="step2Checks" class="d-none">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="checkTemplate" disabled>
                                                <label class="form-check-label" for="checkTemplate">
                                                    <small>✓ اختيار القالب القانوني</small>
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Step 3 Checks -->
                                        <div id="step3Checks" class="d-none">
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-eye me-2"></i>
                                                <small>راجع جميع البيانات قبل المتابعة</small>
                                            </div>
                                        </div>

                                        <!-- Step 4 Checks -->
                                        <div id="step4Checks" class="d-none">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="checkPayment" disabled>
                                                <label class="form-check-label" for="checkPayment">
                                                    <small>✓ اختيار طريقة الدفع</small>
                                                </label>
                                            </div>
                                        </div>

                                        <hr>
                                        
                                        <!-- Progress Summary -->
                                        <div class="text-center">
                                            <div class="progress mb-2" style="height: 25px;">
                                                <div class="progress-bar bg-success" id="progressBar" role="progressbar" 
                                                     style="width: 0%">0%</div>
                                            </div>
                                            <small class="text-muted">التقدم الكلي</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Template Selection -->
                    <div class="step-content d-none" id="step2">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-alt me-2"></i>
                                    اختيار القالب القانوني
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">اختيار القالب القانوني <span class="text-danger">*</span></label>
                                        <select class="form-control" id="templateSelect" name="template_id" required>
                                            <option value="">اختر القالب المناسب</option>
                                            {% if templates %}
                                                {% for template in templates %}
                                                <option value="{{ template.id }}" data-type="{{ template.template_type }}" data-version="{{ template.version }}">
                                                    {{ template.name }} - الإصدار {{ template.version }} 
                                                    {% if template.is_published %}<span class="text-success">(نشط)</span>{% endif %}
                                                </option>
                                                {% endfor %}
                                            {% else %}
                                                <option value="" disabled>لا توجد قوالب متاحة</option>
                                            {% endif %}
                                        </select>
                                        <div class="form-text text-info">
                                            <i class="fas fa-info-circle"></i>
                                            القوالب المركزية فقط - لا يُسمح بإنشاء قوالب خارجية
                                        </div>
                                        {% if not templates %}
                                        <div class="alert alert-warning mt-2">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            لا توجد قوالب متاحة. يرجى إضافة قوالب من 
                                            <a href="{% url 'requests:templates_list' %}" class="alert-link">صفحة القوالب</a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Template Preview -->
                                <div class="template-preview" id="templatePreview">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        اختر نوع التفويض لعرض القالب
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Review -->
                    <div class="step-content d-none" id="step3">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-eye me-2"></i>
                                    مراجعة البيانات قبل الإرسال
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>بيانات العميل:</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>الاسم:</strong></td><td id="reviewName">-</td></tr>
                                            <tr><td><strong>الهوية:</strong></td><td id="reviewId">-</td></tr>
                                            <tr><td><strong>تاريخ الميلاد:</strong></td><td id="reviewBirth">-</td></tr>
                                            <tr><td><strong>الجنسية:</strong></td><td id="reviewNationality">-</td></tr>
                                            <tr><td><strong>الجوال:</strong></td><td id="reviewMobile">-</td></tr>
                                            <tr><td><strong>البريد:</strong></td><td id="reviewEmail">-</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>تفاصيل الطلب:</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>الرقم المرجعي:</strong></td><td id="reviewReference">-</td></tr>
                                            <tr><td><strong>نوع الطلب:</strong></td><td id="reviewType">-</td></tr>
                                            <tr><td><strong>نوع التفويض:</strong></td><td id="reviewAuthType">-</td></tr>
                                            <tr><td><strong>إصدار القالب:</strong></td><td id="reviewVersion">-</td></tr>
                                            <tr><td><strong>تاريخ الطلب:</strong></td><td id="reviewDate">-</td></tr>
                                            <tr><td><strong>صورة الهوية:</strong></td><td id="reviewImage">-</td></tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Payment -->
                    <div class="step-content d-none" id="step4">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-credit-card me-2"></i>
                                    الدفع والرسوم
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>تفاصيل الرسوم:</h6>
                                        <table class="table">
                                            <tr>
                                                <td>نوع الخدمة:</td>
                                                <td class="text-end"><strong id="serviceName">-</strong></td>
                                            </tr>
                                            <tr>
                                                <td>رسوم الخدمة:</td>
                                                <td class="text-end"><strong id="servicePrice">0 درهم</strong></td>
                                            </tr>
                                            <tr>
                                                <td>الضريبة (5%):</td>
                                                <td class="text-end"><strong id="taxAmount">0 درهم</strong></td>
                                            </tr>
                                            <tr class="table-active">
                                                <td><strong>المجموع الكلي:</strong></td>
                                                <td class="text-end"><strong class="text-primary fs-5" id="totalAmount">0 درهم</strong></td>
                                            </tr>
                                        </table>
                                        <div class="alert alert-info mt-3">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <small>الأسعار شاملة ضريبة القيمة المضافة (5%)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>طرق الدفع (إجباري):</h6>
                                        <div class="payment-methods">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="paymentMethod" 
                                                       id="paytabs" value="paytabs" checked>
                                                <label class="form-check-label" for="paytabs">
                                                    <i class="fas fa-credit-card me-2"></i>
                                                    دفع إلكتروني (PayTabs) - <strong>متاح بالفعل</strong>
                                                </label>
                                                <div class="form-text text-success">
                                                    <i class="fas fa-check-circle"></i>
                                                    رابط آمن للدفع المركزي
                                                </div>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="paymentMethod" 
                                                       id="cash" value="cash">
                                                <label class="form-check-label" for="cash">
                                                    <i class="fas fa-money-bill-wave me-2"></i>
                                                    دفع نقدي (مع إيصال)
                                                </label>
                                                <div class="form-text text-info">
                                                    <i class="fas fa-info-circle"></i>
                                                    يُسجل مع رقم الإيصال فقط
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>مهم:</strong> لا يمكن إغلاق الطلب بدون تأكيد الدفع
                                        </div>
                                        
                                        <div class="cash-receipt d-none" id="cashReceipt">
                                            <label class="form-label">رقم الإيصال:</label>
                                            <input type="text" class="form-control" id="receiptNumber" name="receiptNumber"
                                                   placeholder="أدخل رقم الإيصال">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card shadow-custom">
                                <div class="card-body text-center">
                                    <button type="button" class="btn btn-secondary me-2" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                                        <i class="fas fa-arrow-right me-1"></i>
                                        السابق
                                    </button>
                                    
                                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">
                                        التالي
                                        <i class="fas fa-arrow-left me-1"></i>
                                    </button>
                                    
                                    <button type="submit" class="btn btn-success d-none" id="submitBtn">
                                        <i class="fas fa-check me-1"></i>
                                        إنشاء الطلب
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
{% block extra_js %}
    <!-- Form-specific JavaScript -->
    <script>
        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            setupImageUpload();
            setupValidation();
            loadSavedData();
            setupAutoSave();
        });
        
        // دالة تبديل نموذج العميل (موجود أو جديد)
        function toggleCustomerForm() {
            const existingOption = document.getElementById('existingCustomer');
            const existingSection = document.getElementById('existingCustomerSection');
            const newSection = document.getElementById('newCustomerSection');
            
            if (existingOption.checked) {
                existingSection.classList.remove('d-none');
                newSection.classList.add('d-none');
                // تعطيل حقول العميل الجديد
                newSection.querySelectorAll('input[required], select[required]').forEach(input => {
                    input.removeAttribute('required');
                });
            } else {
                existingSection.classList.add('d-none');
                newSection.classList.remove('d-none');
                // تفعيل حقول العميل الجديد
                newSection.querySelectorAll('input[data-required], select[data-required]').forEach(input => {
                    input.setAttribute('required', 'required');
                });
            }
        }
        
        // دالة اختيار عميل موجود
        function selectExistingCustomer(id, name, emirates_id, phone, email) {
            document.getElementById('existingCustomerId').value = id;
            document.getElementById('selectedCustomerName').textContent = name;
            document.getElementById('selectedCustomerAlert').classList.remove('d-none');
            
            // تمييز العميل المختار
            document.querySelectorAll('#customerSearchResults .list-group-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.list-group-item').classList.add('active');
        }
        
        // دالة البحث عن العملاء (مستقبلاً AJAX)
        function searchCustomers() {
            const query = document.getElementById('customerSearch').value;
            // هنا سيتم إضافة AJAX للبحث لاحقاً
            console.log('البحث عن:', query);
        }

        function generateReferenceNumber() {
            // تنسيق: QL-YYYY-NNN (Quick Link - السنة - رقم تسلسلي)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const hours = String(today.getHours()).padStart(2, '0');
            const minutes = String(today.getMinutes()).padStart(2, '0');
            const seconds = String(today.getSeconds()).padStart(2, '0');
            
            // رقم عشوائي لضمان التفرد
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            // التنسيق النهائي: QL-YYYY-MMDD-HHMMSS-RRR
            const referenceNumber = `QL-${year}-${month}${day}-${hours}${minutes}${seconds}-${random}`;
            
            return referenceNumber;
        }

        function initializeForm() {
            // Set today's date
            const today = new Date();
            document.getElementById('requestDate').value = today.toISOString().split('T')[0];
            
            // Generate reference number
            document.getElementById('referenceNumber').value = generateReferenceNumber();
            
            // Set date of birth constraints
            const dobInput = document.getElementById('dateOfBirth');
            const maxDate = new Date(today);
            maxDate.setFullYear(today.getFullYear() - 7); // 7 سنوات للخلف
            
            const minDate = new Date(today);
            minDate.setFullYear(today.getFullYear() - 120); // 120 سنة للخلف
            
            dobInput.setAttribute('max', maxDate.toISOString().split('T')[0]);
            dobInput.setAttribute('min', minDate.toISOString().split('T')[0]);
        }

        function setupImageUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('idImage');
            const previewArea = document.getElementById('previewArea');
            const imagePreview = document.getElementById('imagePreview');

            if (!uploadArea || !fileInput) return;

            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            function handleFileSelect(file) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        uploadArea.classList.add('d-none');
                        previewArea.classList.remove('d-none');
                        
                        // ✅ تحديث checklist - الصورة رُفعت
                        const checkImage = document.getElementById('checkImage');
                        if (checkImage) {
                            checkImage.checked = true;
                            checkImage.disabled = false;
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('يرجى اختيار ملف صورة صالح');
                }
            }
        }

        function removeImage() {
            document.getElementById('idImage').value = '';
            document.getElementById('uploadArea').classList.remove('d-none');
            document.getElementById('previewArea').classList.add('d-none');
            
            // ✅ تحديث checklist - الصورة أُزيلت
            const checkImage = document.getElementById('checkImage');
            if (checkImage) {
                checkImage.checked = false;
                checkImage.disabled = true;
            }
        }

        function setupValidation() {
            // التحقق من تطابق الأسماء
            const customerName = document.getElementById('customerName');
            const confirmName = document.getElementById('confirmName');
            if (customerName && confirmName) {
                customerName.addEventListener('input', checkNameMatch);
                confirmName.addEventListener('input', checkNameMatch);
            }
            
            // التحقق من رقم الهوية
            const emiratesId = document.getElementById('emiratesId');
            if (emiratesId) {
                emiratesId.addEventListener('input', validateEmiratesId);
            }
            
            // التحقق من تاريخ الميلاد
            const dateOfBirth = document.getElementById('dateOfBirth');
            if (dateOfBirth) {
                dateOfBirth.addEventListener('change', validateDateOfBirth);
            }
        }

        function checkNameMatch() {
            const name = document.getElementById('customerName').value;
            const confirmName = document.getElementById('confirmName').value;
            const errorDiv = document.getElementById('nameMatchError');
            const successDiv = document.getElementById('nameMatchSuccess');
            const checkbox = document.getElementById('checkName');
            
            if (name && confirmName) {
                if (name === confirmName) {
                    errorDiv.style.display = 'none';
                    successDiv.style.display = 'block';
                    checkbox.checked = true;
                    checkbox.disabled = false;
                } else {
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    checkbox.checked = false;
                    checkbox.disabled = true;
                }
            } else {
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                checkbox.checked = false;
                checkbox.disabled = true;
            }
            updateProgressBar();
        }

        function validateEmiratesId() {
            const idInput = document.getElementById('emiratesId');
            const id = idInput.value.trim();
            const errorDiv = document.getElementById('idFormatError');
            const successDiv = document.getElementById('idFormatSuccess');
            const warningDiv = document.getElementById('idConflictWarning');
            const checkbox = document.getElementById('checkId');
            
            // Pattern: 784-YYYY-NNNNNNN-D
            const idPattern = /^784-\d{4}-\d{7}-\d{1}$/;
            
            if (id) {
                if (idPattern.test(id)) {
                    // ✅ التنسيق صحيح
                    errorDiv.style.display = 'none';
                    successDiv.style.display = 'block';
                    checkbox.checked = true;
                    checkbox.disabled = false;
                    idInput.classList.remove('is-invalid');
                    idInput.classList.add('is-valid');
                    
                    // فحص التعارض في الهوية
                    checkIdentityConflict(document.getElementById('customerName').value, id);
                } else {
                    // ❌ التنسيق خاطئ
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    warningDiv.style.display = 'none';
                    checkbox.checked = false;
                    checkbox.disabled = true;
                    idInput.classList.remove('is-valid');
                    idInput.classList.add('is-invalid');
                    
                    // تحليل الخطأ للمستخدم
                    analyzeIdError(id, errorDiv);
                }
            } else {
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                warningDiv.style.display = 'none';
                checkbox.checked = false;
                checkbox.disabled = true;
                idInput.classList.remove('is-valid', 'is-invalid');
            }
            updateProgressBar();
        }
        
        function analyzeIdError(id, errorDiv) {
            const parts = id.split('-');
            let errorMsg = '<i class="fas fa-exclamation-triangle"></i> <strong>خطأ!</strong> ';
            
            if (parts.length !== 4) {
                errorMsg += `يجب أن يحتوي على 4 أجزاء مفصولة بـ (-)<br><small>مثال: 784-1990-1234567-8</small>`;
            } else {
                if (parts[0] !== '784') {
                    errorMsg += `يجب أن يبدأ بـ 784<br>`;
                }
                if (parts[1].length !== 4 || !/^\d+$/.test(parts[1])) {
                    errorMsg += `الجزء الثاني يجب أن يكون 4 أرقام (أنت كتبت: ${parts[1].length} أرقام)<br>`;
                }
                if (parts[2].length !== 7 || !/^\d+$/.test(parts[2])) {
                    errorMsg += `الجزء الثالث يجب أن يكون 7 أرقام (أنت كتبت: ${parts[2].length} أرقام)<br>`;
                }
                if (parts[3].length !== 1 || !/^\d+$/.test(parts[3])) {
                    errorMsg += `الجزء الأخير يجب أن يكون رقم واحد<br>`;
                }
                errorMsg += '<small>مثال صحيح: 784-1990-1234567-8</small>';
            }
            
            errorDiv.innerHTML = errorMsg;
        }

        function checkIdentityConflict(name, id) {
            // محاكاة فحص التعارض
            if (name === "أحمد محمد علي" && id !== "784-1234-5678901-2") {
                document.getElementById('idConflictWarning').style.display = 'block';
                showNotification('تحذير: اكتشاف اسم مكرر مع هوية مختلفة!', 'danger');
            } else {
                document.getElementById('idConflictWarning').style.display = 'none';
            }
        }
        
        function validateDateOfBirth() {
            const dobInput = document.getElementById('dateOfBirth');
            const dob = new Date(dobInput.value);
            const today = new Date();
            const errorDiv = document.getElementById('dobError');
            const errorMsg = document.getElementById('dobErrorMsg');
            const successDiv = document.getElementById('dobSuccess');
            const ageDisplay = document.getElementById('ageDisplay');
            
            if (!dobInput.value) {
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                dobInput.classList.remove('is-valid', 'is-invalid');
                return;
            }
            
            // حساب العمر
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            
            // التحقق من التاريخ
            if (dob > today) {
                // تاريخ من المستقبل
                errorMsg.textContent = 'لا يمكن اختيار تاريخ من المستقبل!';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                dobInput.classList.remove('is-valid');
                dobInput.classList.add('is-invalid');
            } else if (age < 7) {
                // أقل من 7 سنوات
                errorMsg.textContent = `العمر ${age} سنوات - يجب أن يكون 7 سنوات على الأقل`;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                dobInput.classList.remove('is-valid');
                dobInput.classList.add('is-invalid');
            } else if (age > 120) {
                // أكثر من 120 سنة (غير معقول)
                errorMsg.textContent = `العمر ${age} سنة - يرجى التحقق من التاريخ`;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                dobInput.classList.remove('is-valid');
                dobInput.classList.add('is-invalid');
            } else {
                // صحيح
                ageDisplay.textContent = age;
                errorDiv.style.display = 'none';
                successDiv.style.display = 'block';
                dobInput.classList.remove('is-invalid');
                dobInput.classList.add('is-valid');
            }
        }

        // ============ نظام الحفظ التلقائي ============
        
        function saveFormData() {
            const formData = {
                customerName: document.getElementById('customerName')?.value || '',
                confirmName: document.getElementById('confirmName')?.value || '',
                emiratesId: document.getElementById('emiratesId')?.value || '',
                dateOfBirth: document.getElementById('dateOfBirth')?.value || '',
                nationality: document.getElementById('nationality')?.value || '',
                mobileNumber: document.getElementById('mobileNumber')?.value || '',
                email: document.getElementById('email')?.value || '',
                requestType: document.getElementById('requestType')?.value || '',
                priority: document.getElementById('priority')?.value || '',
                dueDate: document.getElementById('dueDate')?.value || '',
                hasImage: document.getElementById('idImage')?.files.length > 0,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('createRequestFormData', JSON.stringify(formData));
        }
        
        function loadSavedData() {
            const savedData = localStorage.getItem('createRequestFormData');
            
            if (!savedData) {
                console.log('ℹ️ لا توجد بيانات محفوظة');
                return;
            }
            
            try {
                const formData = JSON.parse(savedData);
                
                // التحقق من عمر البيانات
                const savedTime = new Date(formData.timestamp);
                const now = new Date();
                const minutesDiff = (now - savedTime) / (1000 * 60); // الفرق بالدقائق
                const hoursDiff = minutesDiff / 60; // الفرق بالساعات
                
                // حذف البيانات إذا كانت أقدم من 24 ساعة
                if (hoursDiff > 24) {
                    console.log('⏰ البيانات المحفوظة قديمة (أكثر من 24 ساعة)');
                    localStorage.removeItem('createRequestFormData');
                    return;
                }
                
                // حذف البيانات إذا كانت حديثة جداً (أقل من دقيقة) - غالباً تم إرسالها للتو
                if (minutesDiff < 1) {
                    console.log('⏰ البيانات حديثة جداً (أقل من دقيقة) - غالباً تم إرسالها - تم الحذف');
                    localStorage.removeItem('createRequestFormData');
                    return;
                }
                
                // إخفاء الرسالة إذا كانت البيانات أقدم من 5 دقائق
                if (minutesDiff > 5) {
                    console.log('⏰ البيانات المحفوظة قديمة (أكثر من 5 دقائق) - تم إخفاء الرسالة');
                    localStorage.removeItem('createRequestFormData');
                    return;
                }
                
                // التحقق من وجود بيانات فعلية (ليست فارغة)
                const hasData = formData.customerName || formData.emiratesId || formData.email || formData.mobileNumber;
                if (!hasData) {
                    console.log('ℹ️ لا توجد بيانات مهمة محفوظة');
                    localStorage.removeItem('createRequestFormData');
                    return;
                }
                
                // عرض رسالة للمستخدم فقط إذا البيانات بين 1-5 دقائق
                if (confirm('تم العثور على بيانات محفوظة منذ ' + Math.round(minutesDiff) + ' دقيقة. هل تريد استعادتها؟')) {
                    // استعادة البيانات
                    if (formData.customerName) document.getElementById('customerName').value = formData.customerName;
                    if (formData.confirmName) document.getElementById('confirmName').value = formData.confirmName;
                    if (formData.emiratesId) document.getElementById('emiratesId').value = formData.emiratesId;
                    if (formData.dateOfBirth) document.getElementById('dateOfBirth').value = formData.dateOfBirth;
                    if (formData.nationality) document.getElementById('nationality').value = formData.nationality;
                    if (formData.mobileNumber) document.getElementById('mobileNumber').value = formData.mobileNumber;
                    if (formData.email) document.getElementById('email').value = formData.email;
                    if (formData.requestType) document.getElementById('requestType').value = formData.requestType;
                    if (formData.priority) document.getElementById('priority').value = formData.priority;
                    if (formData.dueDate) document.getElementById('dueDate').value = formData.dueDate;
                    
                    // تحديث checklist للصورة
                    if (formData.hasImage) {
                        const checkImage = document.getElementById('checkImage');
                        if (checkImage) {
                            checkImage.checked = true;
                            checkImage.disabled = false;
                        }
                    }
                    
                    // تشغيل التحقق
                    checkNameMatch();
                    validateEmiratesId();
                    validateDateOfBirth();
                } else {
                    // حذف البيانات المحفوظة
                    localStorage.removeItem('createRequestFormData');
                }
            } catch (error) {
                console.error('❌ خطأ في تحميل البيانات:', error);
                localStorage.removeItem('createRequestFormData');
            }
        }
        
        function setupAutoSave() {
            // حفظ عند كل تغيير في الحقول
            const inputs = document.querySelectorAll('#createRequestForm input, #createRequestForm select');
            inputs.forEach(input => {
                input.addEventListener('change', saveFormData);
                input.addEventListener('input', debounce(saveFormData, 1000)); // حفظ بعد ثانية من التوقف عن الكتابة
            });
            
            // حفظ عند تغيير الخطوة
            window.addEventListener('beforeunload', saveFormData);
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function clearSavedData() {
            localStorage.removeItem('createRequestFormData');
            console.log('🗑️ تم حذف البيانات المحفوظة');
        }

        // Form submission - بسيط وواضح
        document.getElementById('createRequestForm').addEventListener('submit', function(e) {
            console.log('📝 محاولة إرسال النموذج');
            
            // حذف البيانات المحفوظة
            clearSavedData();
            
            // السماح بالإرسال - Django سيتحقق من كل شيء
            console.log('✅ إرسال النموذج إلى Django');
        });
    </script>
{% endblock %}
{% endblock content %}

