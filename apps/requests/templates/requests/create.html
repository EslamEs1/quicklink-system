{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Progress Steps -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-custom">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <div class="step-item active">
                                            <div class="step-number">1</div>
                                            <div class="step-title">بيانات العميل</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="step-item">
                                            <div class="step-number">2</div>
                                            <div class="step-title">اختيار القالب</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="step-item">
                                            <div class="step-number">3</div>
                                            <div class="step-title">مراجعة البيانات</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="step-item">
                                            <div class="step-number">4</div>
                                            <div class="step-title">الدفع والإرسال</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Form -->
                <form id="createRequestForm" method="post" action="{% url 'requests:create' %}" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <!-- Step 1: Customer Information -->
                    <div class="step-content" id="step1">
                        <div class="row">
                            <div class="col-lg-8">
                                <!-- اختيار: عميل موجود أو جديد -->
                                <div class="card shadow-custom mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-users me-2"></i>
                                            اختر طريقة إدخال بيانات العميل
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="customerOption" 
                                                           id="existingCustomer" value="existing" onchange="toggleCustomerForm()">
                                                    <label class="form-check-label" for="existingCustomer">
                                                        <i class="fas fa-user-check text-success me-1"></i>
                                                        <strong>اختيار عميل موجود</strong>
                                                    </label>
                                                </div>
                                                <small class="text-muted d-block mt-1">ملف العميل موجود مسبقاً في النظام</small>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="customerOption" 
                                                           id="newCustomer" value="new" checked onchange="toggleCustomerForm()">
                                                    <label class="form-check-label" for="newCustomer">
                                                        <i class="fas fa-user-plus text-primary me-1"></i>
                                                        <strong>إضافة عميل جديد</strong>
                                                    </label>
                                                </div>
                                                <small class="text-muted d-block mt-1">أول طلب للعميل - إنشاء ملف جديد</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- اختيار عميل موجود -->
                                <div class="card shadow-custom mb-4 d-none" id="existingCustomerSection">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-search me-2"></i>
                                            اختيار عميل من القائمة
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">البحث عن العميل <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control form-control-lg" id="customerSearch" 
                                                   placeholder="ابحث بالاسم أو رقم الهوية أو رقم الجوال...">
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                ابدأ الكتابة لعرض النتائج
                                            </div>
                                        </div>
                                        
                                        <div id="customerSearchResults" class="list-group">
                                            <!-- نتائج البحث ستظهر هنا -->
                                            {% if customers %}
                                                {% for customer in customers|slice:":10" %}
                                                <a href="#" class="list-group-item list-group-item-action" 
                                                   onclick="selectExistingCustomer({{ customer.id }}, '{{ customer.full_name }}', '{{ customer.masked_emirates_id }}', '{{ customer.phone }}', '{{ customer.email }}'); return false;">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <i class="fas fa-user text-primary me-2"></i>
                                                            <strong>{{ customer.full_name }}</strong>
                                                            <br>
                                                            <small class="text-muted">
                                                                <i class="fas fa-id-card me-1"></i>{{ customer.masked_emirates_id }}
                                                                <span class="mx-2">|</span>
                                                                <i class="fas fa-phone me-1"></i>{{ customer.masked_phone }}
                                                            </small>
                                                        </div>
                                                        <span class="badge bg-success">{{ customer.requests.count }} طلبات</span>
                                                    </div>
                                                </a>
                                                {% endfor %}
                                            {% else %}
                                                <div class="text-center text-muted py-3">
                                                    <i class="fas fa-search fa-2x mb-2 d-block"></i>
                                                    <p>ابحث عن عميل...</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="alert alert-success mt-3 d-none" id="selectedCustomerAlert">
                                            <i class="fas fa-check-circle me-2"></i>
                                            تم اختيار العميل: <strong id="selectedCustomerName"></strong>
                                        </div>
                                        <input type="hidden" name="existing_customer_id" id="existingCustomerId">
                                    </div>
                                </div>

                                <!-- نموذج عميل جديد -->
                                <div class="card shadow-custom" id="newCustomerSection">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-user me-2"></i>
                                            بيانات العميل الأساسية
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <!-- Reference Number -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الرقم المرجعي للطلب</label>
                                                <input type="text" class="form-control" id="referenceNumber" 
                                                       data-auto-reference readonly>
                                            </div>
                                            
                                            <!-- Request Date -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تاريخ الطلب</label>
                                                <input type="date" class="form-control" id="requestDate" name="request_date"
                                                       value="" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Customer Name -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الاسم الكامل للعميل <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="customerName" name="customerName"
                                                       placeholder="أدخل الاسم الكامل" required>
                                            </div>
                                            
                                            <!-- Confirm Name -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تأكيد الاسم <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="confirmName" 
                                                       placeholder="أعد كتابة الاسم للتأكيد" required>
                                                <div class="form-text text-danger" id="nameMatchError" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    الأسماء غير متطابقة!
                                                </div>
                                                <div class="form-text text-success" id="nameMatchSuccess" style="display: none;">
                                                    <i class="fas fa-check-circle"></i>
                                                    الأسماء متطابقة ✓
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Emirates ID -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">رقم الهوية الإماراتية <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="emiratesId" 
                                                       placeholder="784-XXXX-XXXXXXX-X" maxlength="18" required>
                                                <div class="form-text">يجب أن يبدأ بـ 784 ويتكون من 15 رقم</div>
                                                <div class="form-text text-danger" id="idFormatError" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    تنسيق خاطئ! يجب أن يكون: 784-XXXX-XXXXXXX-X
                                                </div>
                                                <div class="form-text text-success" id="idFormatSuccess" style="display: none;">
                                                    <i class="fas fa-check-circle"></i>
                                                    تنسيق صحيح ✓
                                                </div>
                                                <div class="form-text text-warning" id="idConflictWarning" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    تحذير: نفس الاسم مع هوية مختلفة!
                                                </div>
                                            </div>
                                            
                                            <!-- Date of Birth -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تاريخ الميلاد <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="dateOfBirth" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Nationality -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الجنسية <span class="text-danger">*</span></label>
                                                <select class="form-control" id="nationality" required>
                                                    <option value="">اختر الجنسية</option>
                                                    <option value="emirati">إماراتي</option>
                                                    <option value="saudi">سعودي</option>
                                                    <option value="egyptian">مصري</option>
                                                    <option value="indian">هندي</option>
                                                    <option value="pakistani">باكستاني</option>
                                                    <option value="other">أخرى</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Mobile Number -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">رقم الجوال <span class="text-danger">*</span></label>
                                                <input type="tel" class="form-control" id="mobileNumber" 
                                                       placeholder="+971-XX-XXX-XXXX" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Email -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">البريد الإلكتروني</label>
                                                <input type="email" class="form-control" id="email" 
                                                       placeholder="example@email.com">
                                            </div>
                                            
                                            <!-- Request Type -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">نوع الطلب <span class="text-danger">*</span></label>
                                                <select class="form-control" id="requestType" required>
                                                    <option value="">اختر نوع الطلب</option>
                                                    <option value="paytabs-link">ربط حساب PayTabs</option>
                                                    <option value="payment-gateway">بوابة دفع إلكترونية</option>
                                                    <option value="bank-integration">تكامل بنكي</option>
                                                    <option value="other">أخرى</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ID Upload Section -->
                            <div class="col-lg-4">
                                <div class="card shadow-custom">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-camera me-2"></i>
                                            صورة الهوية
                                        </h5>
                                    </div>
                                    <div class="card-body text-center">
                                        <div class="upload-area" id="uploadArea">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">اسحب وأفلت صورة الهوية هنا</p>
                                            <p class="text-muted small">أو انقر للاختيار</p>
                                            <input type="file" id="idImage" accept="image/*" class="d-none" required>
                                        </div>
                                        <div class="preview-area d-none" id="previewArea">
                                            <img id="imagePreview" class="img-fluid rounded mb-2" style="max-height: 200px;">
                                            <button type="button" class="btn btn-sm btn-danger" onclick="removeImage()">
                                                <i class="fas fa-trash me-1"></i>إزالة
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Validation Checklist -->
                                <div class="card shadow-custom mt-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-check-circle me-2"></i>
                                            قائمة التحقق
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="checkName" disabled>
                                            <label class="form-check-label" for="checkName">
                                                تطابق الأسماء
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="checkId" disabled>
                                            <label class="form-check-label" for="checkId">
                                                صحة رقم الهوية (784-XXXX-XXXXXXX-X)
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="checkImage" disabled>
                                            <label class="form-check-label" for="checkImage">
                                                رفع صورة الهوية (إجباري)
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="checkTemplate" disabled>
                                            <label class="form-check-label" for="checkTemplate">
                                                اختيار القالب القانوني
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="checkData" disabled>
                                            <label class="form-check-label" for="checkData">
                                                اكتمال جميع البيانات
                                            </label>
                                        </div>
                                        <hr>
                                        <div class="text-center">
                                            <button type="button" class="btn btn-success w-100" id="createDraftBtn" disabled>
                                                <i class="fas fa-file-alt me-1"></i>
                                                إنشاء درافت
                                            </button>
                                            <small class="text-muted d-block mt-2">
                                                يجب إكمال جميع عناصر التحقق أولاً
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Template Selection -->
                    <div class="step-content d-none" id="step2">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-alt me-2"></i>
                                    اختيار القالب القانوني
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">نوع التفويض <span class="text-danger">*</span></label>
                                        <select class="form-control" id="authorizationType" required>
                                            <option value="">اختر نوع التفويض</option>
                                            <option value="payment-authorization">تفويض دفع (قالب مركزي)</option>
                                            <option value="account-management">إدارة الحساب (قالب مركزي)</option>
                                            <option value="financial-operations">العمليات المالية (قالب مركزي)</option>
                                            <option value="general-authorization">تفويض عام (قالب مركزي)</option>
                                        </select>
                                        <div class="form-text text-info">
                                            <i class="fas fa-info-circle"></i>
                                            القوالب المركزية فقط - لا يُسمح بإنشاء قوالب خارجية
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">إصدار القالب <span class="text-danger">*</span></label>
                                        <select class="form-control" id="templateVersion" required>
                                            <option value="">اختر الإصدار</option>
                                            <option value="v1.0">الإصدار 1.0 (الحالي - محدث)</option>
                                            <option value="v0.9">الإصدار 0.9 (منتهي الصلاحية)</option>
                                        </select>
                                        <div class="form-text text-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            يُنصح بالإصدار الحالي دائماً
                                        </div>
                                    </div>
                                </div>

                                <!-- Template Preview -->
                                <div class="template-preview" id="templatePreview">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        اختر نوع التفويض لعرض القالب
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Review -->
                    <div class="step-content d-none" id="step3">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-eye me-2"></i>
                                    مراجعة البيانات قبل الإرسال
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>بيانات العميل:</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>الاسم:</strong></td><td id="reviewName">-</td></tr>
                                            <tr><td><strong>الهوية:</strong></td><td id="reviewId">-</td></tr>
                                            <tr><td><strong>تاريخ الميلاد:</strong></td><td id="reviewBirth">-</td></tr>
                                            <tr><td><strong>الجنسية:</strong></td><td id="reviewNationality">-</td></tr>
                                            <tr><td><strong>الجوال:</strong></td><td id="reviewMobile">-</td></tr>
                                            <tr><td><strong>البريد:</strong></td><td id="reviewEmail">-</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>تفاصيل الطلب:</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>الرقم المرجعي:</strong></td><td id="reviewReference">-</td></tr>
                                            <tr><td><strong>نوع الطلب:</strong></td><td id="reviewType">-</td></tr>
                                            <tr><td><strong>نوع التفويض:</strong></td><td id="reviewAuthType">-</td></tr>
                                            <tr><td><strong>إصدار القالب:</strong></td><td id="reviewVersion">-</td></tr>
                                            <tr><td><strong>تاريخ الطلب:</strong></td><td id="reviewDate">-</td></tr>
                                            <tr><td><strong>صورة الهوية:</strong></td><td id="reviewImage">-</td></tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Payment -->
                    <div class="step-content d-none" id="step4">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-credit-card me-2"></i>
                                    الدفع والرسوم
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>تفاصيل الرسوم:</h6>
                                        <table class="table">
                                            <tr>
                                                <td>رسوم المعالجة:</td>
                                                <td class="text-end"><strong>250 درهم</strong></td>
                                            </tr>
                                            <tr>
                                                <td>رسوم القالب القانوني:</td>
                                                <td class="text-end"><strong>150 درهم</strong></td>
                                            </tr>
                                            <tr>
                                                <td>الضريبة (5%):</td>
                                                <td class="text-end"><strong>20 درهم</strong></td>
                                            </tr>
                                            <tr class="table-active">
                                                <td><strong>المجموع:</strong></td>
                                                <td class="text-end"><strong class="text-primary">420 درهم</strong></td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>طرق الدفع (إجباري):</h6>
                                        <div class="payment-methods">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="paymentMethod" 
                                                       id="paytabs" value="paytabs" checked>
                                                <label class="form-check-label" for="paytabs">
                                                    <i class="fas fa-credit-card me-2"></i>
                                                    دفع إلكتروني (PayTabs) - <strong>متاح بالفعل</strong>
                                                </label>
                                                <div class="form-text text-success">
                                                    <i class="fas fa-check-circle"></i>
                                                    رابط آمن للدفع المركزي
                                                </div>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="paymentMethod" 
                                                       id="cash" value="cash">
                                                <label class="form-check-label" for="cash">
                                                    <i class="fas fa-money-bill-wave me-2"></i>
                                                    دفع نقدي (مع إيصال)
                                                </label>
                                                <div class="form-text text-info">
                                                    <i class="fas fa-info-circle"></i>
                                                    يُسجل مع رقم الإيصال فقط
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>مهم:</strong> لا يمكن إغلاق الطلب بدون تأكيد الدفع
                                        </div>
                                        
                                        <div class="cash-receipt d-none" id="cashReceipt">
                                            <label class="form-label">رقم الإيصال:</label>
                                            <input type="text" class="form-control" id="receiptNumber" 
                                                   placeholder="أدخل رقم الإيصال">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card shadow-custom">
                                <div class="card-body text-center">
                                    <button type="button" class="btn btn-secondary me-2" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                                        <i class="fas fa-arrow-right me-1"></i>
                                        السابق
                                    </button>
                                    
                                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">
                                        التالي
                                        <i class="fas fa-arrow-left me-1"></i>
                                    </button>
                                    
                                    <button type="submit" class="btn btn-success d-none" id="submitBtn">
                                        <i class="fas fa-check me-1"></i>
                                        إنشاء الطلب
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
{% endblock content %}
