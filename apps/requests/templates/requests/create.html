{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Progress Steps -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-custom">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <div class="step-item active">
                                            <div class="step-number">1</div>
                                            <div class="step-title">بيانات العميل</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="step-item">
                                            <div class="step-number">2</div>
                                            <div class="step-title">اختيار القالب</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="step-item">
                                            <div class="step-number">3</div>
                                            <div class="step-title">مراجعة البيانات</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="step-item">
                                            <div class="step-number">4</div>
                                            <div class="step-title">الدفع والإرسال</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Form -->
                <form id="createRequestForm" method="post" action="{% url 'requests:create' %}" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <!-- Step 1: Customer Information -->
                    <div class="step-content" id="step1">
                        <div class="row">
                            <div class="col-lg-8">
                                <!-- اختيار: عميل موجود أو جديد -->
                                <div class="card shadow-custom mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-users me-2"></i>
                                            اختر طريقة إدخال بيانات العميل
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="customerOption" 
                                                           id="existingCustomer" value="existing" onchange="toggleCustomerForm()">
                                                    <label class="form-check-label" for="existingCustomer">
                                                        <i class="fas fa-user-check text-success me-1"></i>
                                                        <strong>اختيار عميل موجود</strong>
                                                    </label>
                                                </div>
                                                <small class="text-muted d-block mt-1">ملف العميل موجود مسبقاً في النظام</small>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="customerOption" 
                                                           id="newCustomer" value="new" checked onchange="toggleCustomerForm()">
                                                    <label class="form-check-label" for="newCustomer">
                                                        <i class="fas fa-user-plus text-primary me-1"></i>
                                                        <strong>إضافة عميل جديد</strong>
                                                    </label>
                                                </div>
                                                <small class="text-muted d-block mt-1">أول طلب للعميل - إنشاء ملف جديد</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- اختيار عميل موجود -->
                                <div class="card shadow-custom mb-4 d-none" id="existingCustomerSection">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-search me-2"></i>
                                            اختيار عميل من القائمة
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">البحث عن العميل <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control form-control-lg" id="customerSearch" 
                                                   placeholder="ابحث بالاسم أو رقم الهوية أو رقم الجوال...">
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                ابدأ الكتابة لعرض النتائج
                                            </div>
                                        </div>
                                        
                                        <div id="customerSearchResults" class="list-group">
                                            <!-- نتائج البحث ستظهر هنا -->
                                            {% if customers %}
                                                {% for customer in customers|slice:":10" %}
                                                <a href="#" class="list-group-item list-group-item-action" 
                                                   onclick="selectExistingCustomer({{ customer.id }}, '{{ customer.full_name }}', '{{ customer.masked_emirates_id }}', '{{ customer.phone }}', '{{ customer.email }}'); return false;">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <i class="fas fa-user text-primary me-2"></i>
                                                            <strong>{{ customer.full_name }}</strong>
                                                            <br>
                                                            <small class="text-muted">
                                                                <i class="fas fa-id-card me-1"></i>{{ customer.masked_emirates_id }}
                                                                <span class="mx-2">|</span>
                                                                <i class="fas fa-phone me-1"></i>{{ customer.masked_phone }}
                                                            </small>
                                                        </div>
                                                        <span class="badge bg-success">{{ customer.requests.count }} طلبات</span>
                                                    </div>
                                                </a>
                                                {% endfor %}
                                            {% else %}
                                                <div class="text-center text-muted py-3">
                                                    <i class="fas fa-search fa-2x mb-2 d-block"></i>
                                                    <p>ابحث عن عميل...</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="alert alert-success mt-3 d-none" id="selectedCustomerAlert">
                                            <i class="fas fa-check-circle me-2"></i>
                                            تم اختيار العميل: <strong id="selectedCustomerName"></strong>
                                        </div>
                                        <input type="hidden" name="existing_customer_id" id="existingCustomerId">
                                    </div>
                                </div>

                                <!-- نموذج عميل جديد -->
                                <div class="card shadow-custom" id="newCustomerSection">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-user me-2"></i>
                                            بيانات العميل الأساسية
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <!-- Reference Number -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الرقم المرجعي للطلب</label>
                                                <input type="text" class="form-control" id="referenceNumber" 
                                                       data-auto-reference readonly>
                                            </div>
                                            
                                            <!-- Request Date -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تاريخ الطلب</label>
                                                <input type="date" class="form-control" id="requestDate" name="request_date"
                                                       value="" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Customer Name -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الاسم الكامل للعميل <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="customerName" name="customerName"
                                                       placeholder="أدخل الاسم الكامل" required>
                                            </div>
                                            
                                            <!-- Confirm Name -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تأكيد الاسم <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="confirmName" name="confirmName"
                                                       placeholder="أعد كتابة الاسم للتأكيد" required>
                                                <div class="form-text text-danger" id="nameMatchError" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    الأسماء غير متطابقة!
                                                </div>
                                                <div class="form-text text-success" id="nameMatchSuccess" style="display: none;">
                                                    <i class="fas fa-check-circle"></i>
                                                    الأسماء متطابقة ✓
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Emirates ID -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">رقم الهوية الإماراتية <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="emiratesId" name="emiratesId"
                                                       placeholder="784-1990-1234567-8" maxlength="18" required>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    التنسيق: 784-YYYY-NNNNNNN-D (15 رقم + شرطات)
                                                </div>
                                                <div class="form-text text-danger" id="idFormatError" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    <strong>خطأ!</strong> يجب أن يكون: 784-YYYY-NNNNNNN-D
                                                    <br><small>مثال: 784-1990-1234567-8</small>
                                                </div>
                                                <div class="form-text text-success" id="idFormatSuccess" style="display: none;">
                                                    <i class="fas fa-check-circle"></i>
                                                    تنسيق صحيح ✓
                                                </div>
                                                <div class="form-text text-warning" id="idConflictWarning" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    تحذير: نفس الاسم مع هوية مختلفة!
                                                </div>
                                            </div>
                                            
                                            <!-- Date of Birth -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تاريخ الميلاد <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="dateOfBirth" name="date_of_birth" required>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    العمر يجب أن يكون 7 سنوات على الأقل
                                                </div>
                                                <div class="form-text text-danger" id="dobError" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    <span id="dobErrorMsg"></span>
                                                </div>
                                                <div class="form-text text-success" id="dobSuccess" style="display: none;">
                                                    <i class="fas fa-check-circle"></i>
                                                    العمر: <span id="ageDisplay"></span> سنة ✓
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Nationality -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الجنسية <span class="text-danger">*</span></label>
                                                <select class="form-control" id="nationality" name="nationality" required>
                                                    <option value="">اختر الجنسية</option>
                                                    <option value="emirati">إماراتي</option>
                                                    <option value="saudi">سعودي</option>
                                                    <option value="egyptian">مصري</option>
                                                    <option value="indian">هندي</option>
                                                    <option value="pakistani">باكستاني</option>
                                                    <option value="other">أخرى</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Mobile Number -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">رقم الجوال <span class="text-danger">*</span></label>
                                                <input type="tel" class="form-control" id="mobileNumber" name="mobileNumber"
                                                       placeholder="+971-XX-XXX-XXXX" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Email -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">البريد الإلكتروني</label>
                                                <input type="email" class="form-control" id="email" name="email"
                                                       placeholder="example@email.com">
                                            </div>
                                            
                                            <!-- Request Type -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">نوع الطلب <span class="text-danger">*</span></label>
                                                <select class="form-control" id="requestType" name="request_type_id" required>
                                                    <option value="">اختر نوع الطلب</option>
                                                    {% if request_types %}
                                                        {% regroup request_types by category as category_groups %}
                                                        {% for category in category_groups %}
                                                        <optgroup label="{{ category.grouper|title }}">
                                                            {% for type in category.list %}
                                                            <option value="{{ type.id }}" data-price="{{ type.default_price }}">
                                                                {{ type.name_arabic }} - {{ type.default_price }} درهم
                                                            </option>
                                                            {% endfor %}
                                                        </optgroup>
                                                        {% endfor %}
                                                    {% else %}
                                                        <option value="" disabled>لا توجد أنواع متاحة</option>
                                                    {% endif %}
                                                </select>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    اختر نوع الخدمة المطلوبة
                                                    {% if not request_types %}
                                                    <br>
                                                    <span class="text-danger">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                        لا توجد أنواع طلبات. يرجى إضافة أنواع من 
                                                        <a href="{% url 'requests:request_types_list' %}" class="text-danger">صفحة إدارة الأنواع</a>
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <!-- Priority -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الأولوية</label>
                                                <select class="form-control" id="priority" name="priority">
                                                    <option value="medium">متوسطة</option>
                                                    <option value="low">منخفضة</option>
                                                    <option value="high">عالية</option>
                                                    <option value="urgent">عاجلة</option>
                                                </select>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    الأولوية الافتراضية: متوسطة
                                                </div>
                                            </div>
                                            
                                            <!-- Due Date -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تاريخ الاستحقاق</label>
                                                <input type="date" class="form-control" id="dueDate" name="due_date">
                                                <div class="form-text">
                                                    <i class="fas fa-calendar me-1"></i>
                                                    الموعد النهائي لإنجاز الطلب (اختياري)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ID Upload Section -->
                            <div class="col-lg-4">
                                <div class="card shadow-custom" id="imageUploadCard">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-camera me-2"></i>
                                            صورة الهوية
                                        </h5>
                                    </div>
                                    <div class="card-body text-center">
                                        <div class="upload-area border border-2 border-dashed rounded p-4" id="uploadArea" style="border-color: #dee2e6;">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">اسحب وأفلت صورة الهوية هنا</p>
                                            <p class="text-muted small">أو انقر للاختيار</p>
                                            <input type="file" id="idImage" accept="image/*" class="d-none" name="id_image" required>
                                        </div>
                                        <div class="invalid-feedback d-none" id="imageError">
                                            يرجى رفع صورة الهوية
                                        </div>
                                        <div class="preview-area d-none" id="previewArea">
                                            <img id="imagePreview" class="img-fluid rounded mb-2" style="max-height: 200px;">
                                            <button type="button" class="btn btn-sm btn-danger" onclick="removeImage()">
                                                <i class="fas fa-trash me-1"></i>إزالة
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Validation Checklist - ثابت في جميع الخطوات -->
                                <div class="card shadow-custom mt-3" id="checklistCard">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-tasks me-2"></i>
                                            قائمة التحقق - الخطوة <span id="currentStepNum">1</span>
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Step 1 Checks -->
                                        <div id="step1Checks">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="checkName" disabled>
                                                <label class="form-check-label" for="checkName">
                                                    <small>✓ تطابق الأسماء</small>
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="checkId" disabled>
                                                <label class="form-check-label" for="checkId">
                                                    <small>✓ صحة رقم الهوية</small>
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="checkImage" disabled>
                                                <label class="form-check-label" for="checkImage">
                                                    <small>✓ رفع صورة الهوية</small>
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Step 1.5 Checks -->
                                        <div id="step1_5Checks" class="d-none">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="checkDocuments" disabled>
                                                <label class="form-check-label" for="checkDocuments">
                                                    <small>✓ رفع المستندات المطلوبة</small>
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Step 2 Checks -->
                                        <div id="step2Checks" class="d-none">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="checkTemplate" disabled>
                                                <label class="form-check-label" for="checkTemplate">
                                                    <small>✓ اختيار القالب القانوني</small>
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Step 3 Checks -->
                                        <div id="step3Checks" class="d-none">
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-eye me-2"></i>
                                                <small>راجع جميع البيانات قبل المتابعة</small>
                                            </div>
                                        </div>

                                        <!-- Step 4 Checks -->
                                        <div id="step4Checks" class="d-none">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="checkPayment" disabled>
                                                <label class="form-check-label" for="checkPayment">
                                                    <small>✓ اختيار طريقة الدفع</small>
                                                </label>
                                            </div>
                                        </div>

                                        <hr>
                                        
                                        <!-- Progress Summary -->
                                        <div class="text-center">
                                            <div class="progress mb-2" style="height: 25px;">
                                                <div class="progress-bar bg-success" id="progressBar" role="progressbar" 
                                                     style="width: 0%">0%</div>
                                            </div>
                                            <small class="text-muted">التقدم الكلي</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 1.5: Document Upload -->
                    <div class="step-content d-none" id="step1_5">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-paperclip me-2"></i>
                                    رفع المستندات المطلوبة
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>مهم:</strong> يرجى رفع جميع المستندات المطلوبة بجودة عالية ووضوح كامل.
                                </div>
                                
                                <div class="row">
                                    <!-- Emirates ID Image -->
                                    <div class="col-md-6 mb-4">
                                        <label class="form-label">صورة الهوية الإماراتية <span class="text-danger">*</span></label>
                                        <div class="upload-area" id="idImageUpload">
                                            <input type="file" class="form-control" id="idImage" name="idImage" 
                                                   accept="image/*" required>
                                            <div class="upload-preview mt-2" id="idImagePreview"></div>
                                        </div>
                                        <div class="form-text">
                                            <i class="fas fa-camera me-1"></i>
                                            يرجى رفع صورة واضحة للهوية الإماراتية (JPG, PNG)
                                        </div>
                                    </div>

                                    <!-- Additional Documents -->
                                    <div class="col-md-6 mb-4">
                                        <label class="form-label">مستندات إضافية (اختياري)</label>
                                        <div class="upload-area">
                                            <input type="file" class="form-control" id="additionalDocs" name="additional_docs" 
                                                   accept=".pdf,.jpg,.jpeg,.png" multiple>
                                            <div class="upload-preview mt-2" id="additionalDocsPreview"></div>
                                        </div>
                                        <div class="form-text">
                                            <i class="fas fa-file-alt me-1"></i>
                                            يمكن رفع مستندات إضافية مثل: شهادات، عقود، إلخ
                                        </div>
                                    </div>
                                </div>

                                <!-- Uploaded Files Summary -->
                                <div class="uploaded-files-summary" id="uploadedFilesSummary" style="display: none;">
                                    <h6><i class="fas fa-list me-2"></i>الملفات المرفوعة:</h6>
                                    <div id="filesList" class="list-group"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Template Selection -->
                    <div class="step-content d-none" id="step2">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-alt me-2"></i>
                                    اختيار القالب القانوني
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">اختيار القالب القانوني <span class="text-danger">*</span></label>
                                        <select class="form-control" id="templateSelect" name="template_id" required>
                                            <option value="">اختر القالب المناسب</option>
                                            {% if templates %}
                                                {% for template in templates %}
                                                <option value="{{ template.id }}" data-type="{{ template.template_type }}" data-version="{{ template.version }}">
                                                    {{ template.name }} - الإصدار {{ template.version }} 
                                                    {% if template.is_published %}<span class="text-success">(نشط)</span>{% endif %}
                                                </option>
                                                {% endfor %}
                                            {% else %}
                                                <option value="" disabled>لا توجد قوالب متاحة</option>
                                            {% endif %}
                                        </select>
                                        <div class="form-text text-info">
                                            <i class="fas fa-info-circle"></i>
                                            القوالب المركزية فقط - لا يُسمح بإنشاء قوالب خارجية
                                        </div>
                                        {% if not templates %}
                                        <div class="alert alert-warning mt-2">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            لا توجد قوالب متاحة. يرجى إضافة قوالب من 
                                            <a href="{% url 'requests:templates_list' %}" class="alert-link">صفحة القوالب</a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Template Preview -->
                                <div class="template-preview" id="templatePreview">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        اختر نوع التفويض لعرض القالب
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Review -->
                    <div class="step-content d-none" id="step3">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-eye me-2"></i>
                                    مراجعة البيانات قبل الإرسال
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>بيانات العميل:</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>الاسم:</strong></td><td id="reviewName">-</td></tr>
                                            <tr><td><strong>الهوية:</strong></td><td id="reviewId">-</td></tr>
                                            <tr><td><strong>تاريخ الميلاد:</strong></td><td id="reviewBirth">-</td></tr>
                                            <tr><td><strong>الجنسية:</strong></td><td id="reviewNationality">-</td></tr>
                                            <tr><td><strong>الجوال:</strong></td><td id="reviewMobile">-</td></tr>
                                            <tr><td><strong>البريد:</strong></td><td id="reviewEmail">-</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>تفاصيل الطلب:</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>الرقم المرجعي:</strong></td><td id="reviewReference">-</td></tr>
                                            <tr><td><strong>نوع الطلب:</strong></td><td id="reviewType">-</td></tr>
                                            <tr><td><strong>نوع التفويض:</strong></td><td id="reviewAuthType">-</td></tr>
                                            <tr><td><strong>إصدار القالب:</strong></td><td id="reviewVersion">-</td></tr>
                                            <tr><td><strong>تاريخ الطلب:</strong></td><td id="reviewDate">-</td></tr>
                                            <tr><td><strong>صورة الهوية:</strong></td><td id="reviewImage">-</td></tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Payment -->
                    <div class="step-content d-none" id="step4">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-credit-card me-2"></i>
                                    الدفع والرسوم
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>تفاصيل الرسوم:</h6>
                                        <table class="table">
                                            <tr>
                                                <td>نوع الخدمة:</td>
                                                <td class="text-end"><strong id="serviceName">-</strong></td>
                                            </tr>
                                            <tr>
                                                <td>رسوم الخدمة:</td>
                                                <td class="text-end"><strong id="servicePrice">0 درهم</strong></td>
                                            </tr>
                                            <tr>
                                                <td>الضريبة (5%):</td>
                                                <td class="text-end"><strong id="taxAmount">0 درهم</strong></td>
                                            </tr>
                                            <tr class="table-active">
                                                <td><strong>المجموع الكلي:</strong></td>
                                                <td class="text-end"><strong class="text-primary fs-5" id="totalAmount">0 درهم</strong></td>
                                            </tr>
                                        </table>
                                        <div class="alert alert-info mt-3">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <small>الأسعار شاملة ضريبة القيمة المضافة (5%)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>طرق الدفع (إجباري):</h6>
                                        <div class="payment-methods">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="paymentMethod" 
                                                       id="paytabs" value="paytabs" checked>
                                                <label class="form-check-label" for="paytabs">
                                                    <i class="fas fa-credit-card me-2"></i>
                                                    دفع إلكتروني (PayTabs) - <strong>متاح بالفعل</strong>
                                                </label>
                                                <div class="form-text text-success">
                                                    <i class="fas fa-check-circle"></i>
                                                    رابط آمن للدفع المركزي
                                                </div>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="paymentMethod" 
                                                       id="cash" value="cash">
                                                <label class="form-check-label" for="cash">
                                                    <i class="fas fa-money-bill-wave me-2"></i>
                                                    دفع نقدي (مع إيصال)
                                                </label>
                                                <div class="form-text text-info">
                                                    <i class="fas fa-info-circle"></i>
                                                    يُسجل مع رقم الإيصال فقط
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>مهم:</strong> لا يمكن إغلاق الطلب بدون تأكيد الدفع
                                        </div>
                                        
                                        <div class="cash-receipt d-none" id="cashReceipt">
                                            <label class="form-label">رقم الإيصال:</label>
                                            <input type="text" class="form-control" id="receiptNumber" name="receiptNumber"
                                                   placeholder="أدخل رقم الإيصال">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card shadow-custom">
                                <div class="card-body text-center">
                                    <button type="button" class="btn btn-secondary me-2" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                                        <i class="fas fa-arrow-right me-1"></i>
                                        السابق
                                    </button>
                                    
                                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">
                                        التالي
                                        <i class="fas fa-arrow-left me-1"></i>
                                    </button>
                                    
                                    <button type="submit" class="btn btn-success d-none" id="submitBtn">
                                        <i class="fas fa-check me-1"></i>
                                        إنشاء الطلب
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

{% block extra_css %}
<style>
    /* Document Upload Styles */
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9ff;
    }
    
    .upload-area.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
    }
    
    .upload-preview img {
        max-width: 100px;
        max-height: 100px;
        border-radius: 0.375rem;
        margin: 0.25rem;
        border: 1px solid #dee2e6;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        background-color: #f8f9fa;
    }
    
    .file-item .file-info {
        display: flex;
        align-items: center;
    }
    
    .file-item .file-info i {
        margin-right: 0.5rem;
        color: #007bff;
    }
    
    .file-item .file-actions {
        display: flex;
        gap: 0.25rem;
    }
</style>
{% endblock %}

{% block extra_js %}
    <!-- Fixed Form JavaScript -->
    <script src="{% static 'assets/js/create-form.js' %}"></script>
    
    <script>
        // Document Upload JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            const idImageInput = document.getElementById('idImage');
            const idImagePreview = document.getElementById('idImagePreview');
            const additionalDocsInput = document.getElementById('additionalDocs');
            const additionalDocsPreview = document.getElementById('additionalDocsPreview');
            const uploadedFilesSummary = document.getElementById('uploadedFilesSummary');
            const filesList = document.getElementById('filesList');
            
            let uploadedFiles = [];
            
            // Handle Emirates ID Image
            idImageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadedFiles.push({
                        name: file.name,
                        type: 'Emirates ID',
                        file: file
                    });
                    updateFilesList();
                    updateDocumentCheck();
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        idImagePreview.innerHTML = `
                            <img src="${e.target.result}" alt="Emirates ID Preview" class="img-thumbnail">
                            <div class="mt-2">
                                <small class="text-success">
                                    <i class="fas fa-check-circle"></i>
                                    ${file.name}
                                </small>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Handle Additional Documents
            additionalDocsInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    uploadedFiles.push({
                        name: file.name,
                        type: 'Additional Document',
                        file: file
                    });
                });
                updateFilesList();
                updateDocumentCheck();
                
                // Show preview
                let previewHTML = '';
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (file.type.startsWith('image/')) {
                            previewHTML += `<img src="${e.target.result}" alt="${file.name}" class="img-thumbnail me-2">`;
                        } else {
                            previewHTML += `<div class="d-inline-block me-2">
                                <i class="fas fa-file-alt fa-2x text-primary"></i>
                                <div class="small">${file.name}</div>
                            </div>`;
                        }
                        additionalDocsPreview.innerHTML = previewHTML;
                    };
                    reader.readAsDataURL(file);
                });
            });
            
            function updateFilesList() {
                if (uploadedFiles.length > 0) {
                    uploadedFilesSummary.style.display = 'block';
                    filesList.innerHTML = '';
                    
                    uploadedFiles.forEach((file, index) => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `
                            <div class="file-info">
                                <i class="fas fa-file-alt"></i>
                                <span>${file.name}</span>
                                <small class="text-muted ms-2">(${file.type})</small>
                            </div>
                            <div class="file-actions">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                        filesList.appendChild(fileItem);
                    });
                } else {
                    uploadedFilesSummary.style.display = 'none';
                }
            }
            
            function updateDocumentCheck() {
                const checkDocuments = document.getElementById('checkDocuments');
                if (uploadedFiles.length > 0) {
                    checkDocuments.checked = true;
                    checkDocuments.disabled = false;
                } else {
                    checkDocuments.checked = false;
                }
                updateProgress();
            }
            
            // Global function to remove files
            window.removeFile = function(index) {
                uploadedFiles.splice(index, 1);
                updateFilesList();
                updateDocumentCheck();
            };
        });
    </script>
{% endblock %}
{% endblock content %}

