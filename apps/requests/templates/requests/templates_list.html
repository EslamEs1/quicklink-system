{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Page Title -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-file-contract me-2 text-primary"></i>
                    القوالب المركزية القانونية
                </h2>
                <div class="btn-group" role="group">
                    <a href="{% url 'requests:template_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>
                    إضافة قالب جديد
                    </a>
                    <a href="{% url 'requests:template_types_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-list-ul me-1"></i>
                        إدارة أنواع القوالب
                    </a>
                </div>
            </div>

            <!-- Important Notice -->
            <div class="alert alert-warning mb-4">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>مهم:</strong> هذه القوالب المركزية فقط. لا يُسمح بإنشاء قوالب خارجية أو استخدام قوالب قديمة. جميع القوالب محدثة ومصادق عليها قانونياً.
            </div>

            <!-- Search and Filters -->
            <div class="card shadow-custom mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">البحث في القوالب</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" placeholder="البحث بالاسم أو المحتوى" id="templateSearchInput">
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">فلترة حسب النوع</label>
                            <select class="form-control" id="typeFilter">
                                <option value="all">جميع الأنواع</option>
                                {% for template_type in template_types %}
                                <option value="{{ template_type.id }}">{{ template_type.name_arabic }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">فلترة حسب الحالة</label>
                            <select class="form-control" id="statusFilter">
                                <option value="all">جميع الحالات</option>
                                <option value="active">نشط</option>
                                <option value="draft">مسودة</option>
                                <option value="archived">مؤرشف</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button class="btn btn-outline-primary" onclick="clearTemplateFilters()">
                                    <i class="fas fa-times me-1"></i>
                                    مسح الفلاتر
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Template Stats -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-file-alt icon-large text-primary"></i>
                            <div class="stats-number">{{ total_templates|default:0 }}</div>
                            <div class="stats-label">إجمالي القوالب</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-check-circle icon-large text-success"></i>
                            <div class="stats-number">{{ active_templates|default:0 }}</div>
                            <div class="stats-label">قوالب نشطة</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-edit icon-large text-warning"></i>
                            <div class="stats-number">{{ draft_templates|default:0 }}</div>
                            <div class="stats-label">مسودات</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-download icon-large text-info"></i>
                            <div class="stats-number">{{ total_usage|default:0 }}</div>
                            <div class="stats-label">مرات الاستخدام</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Templates Grid -->
            <div class="row">
                {% if templates %}
                    {% for template in templates %}
                <!-- Template Card {{ template.id }} -->
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card template-card shadow-custom">
                        <div class="card-header bg-{{ template.template_type.color|default:'primary' }} text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    {% if template.template_type and template.template_type.icon %}
                                    <i class="fas {{ template.template_type.icon }} me-1"></i>
                                    {% else %}
                                    <i class="fas fa-file-alt me-1"></i>
                                    {% endif %}
                                    {{ template.name }}
                                </h6>
                                <span class="badge 
                                    {% if template.is_published and template.is_active %}bg-success
                                    {% elif not template.is_published %}bg-warning text-dark
                                    {% else %}bg-secondary{% endif %}">
                                    {% if template.is_published and template.is_active %}نشط
                                    {% elif not template.is_published %}مسودة
                                    {% else %}مؤرشف{% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                <small>{{ template.content_arabic|truncatewords:15 }}</small>
                            </p>
                            <div class="template-meta mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">النوع:</span>
                                    {% if template.template_type %}
                                    <span class="badge bg-{{ template.template_type.color }}">
                                        {% if template.template_type.icon %}
                                        <i class="fas {{ template.template_type.icon }} me-1"></i>
                                        {% endif %}
                                        {{ template.template_type.name_arabic }}
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary">بدون نوع</span>
                                    {% endif %}
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">الإصدار:</span>
                                    <strong>{{ template.version }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">مرات الاستخدام:</span>
                                    <strong>{{ template.usage_count|default:0 }} مرة</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">آخر تحديث:</span>
                                    <small>{{ template.updated_at|date:"d يناير Y" }}</small>
                                </div>
                            </div>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewTemplate({{ template.id }})">
                                    <i class="fas fa-eye"></i>
                                    عرض
                                </button>
                                {% if template.is_published and template.is_active %}
                                <button class="btn btn-outline-success btn-sm" onclick="useTemplate({{ template.id }})">
                                    <i class="fas fa-file-download"></i>
                                    استخدام
                                </button>
                                {% elif not template.is_published %}
                                <button class="btn btn-outline-success btn-sm" onclick="publishTemplate({{ template.id }})">
                                    <i class="fas fa-check"></i>
                                    نشر
                                </button>
                                {% endif %}
                                <a href="{% url 'requests:template_edit' template.id %}" class="btn btn-outline-warning btn-sm">
                                    <i class="fas fa-edit"></i>
                                    تعديل
                                </a>
                                {% if template.is_active %}
                                <form method="post" action="{% url 'requests:template_toggle' template.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-secondary btn-sm" title="تعطيل">
                                        <i class="fas fa-pause"></i>
                                    </button>
                                </form>
                                {% else %}
                                <form method="post" action="{% url 'requests:template_toggle' template.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-success btn-sm" title="تفعيل">
                                        <i class="fas fa-play"></i>
                                </button>
                                </form>
                                {% endif %}
                                {% if template.requests.count == 0 %}
                                <a href="{% url 'requests:template_delete' template.id %}" class="btn btn-outline-danger btn-sm" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                    {% endfor %}
                {% else %}
                <div class="col-12">
                    <div class="card shadow-custom">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">لا توجد قوالب</h5>
                            <p class="text-muted">ابدأ بإضافة قالب قانوني جديد</p>
                            <a href="{% url 'requests:template_create' %}" class="btn btn-primary mt-3">
                                <i class="fas fa-plus me-1"></i>
                                إضافة قالب جديد
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
{% endblock content %}
