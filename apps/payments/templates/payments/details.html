{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Include messages component -->
{% include 'message.html' %}

<!-- Page Title -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-0">
            <i class="fas fa-receipt me-2 text-primary"></i>
            تفاصيل الدفعة
        </h2>
        <p class="text-muted mb-0">رقم الدفعة: {{ payment.id }} | رقم الطلب: {{ payment.request.reference_number }}</p>
    </div>
    <div class="btn-group">
        <a href="{% url 'payments:list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-right me-1"></i>
            رجوع للقائمة
        </a>
        {% if payment.status == 'paid' %}
            <button class="btn btn-success" onclick="printReceipt()">
                <i class="fas fa-print me-1"></i>
                طباعة الإيصال
            </button>
        {% endif %}
    </div>
</div>

<!-- Payment Status Alert -->
{% if payment.status == 'paid' %}
    <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <div>
            <strong>تم الدفع بنجاح!</strong> تم معالجة هذه الدفعة بنجاح في {{ payment.created_at|date:"d يناير Y - H:i" }}
        </div>
    </div>
{% elif payment.status == 'pending' %}
    <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
        <i class="fas fa-hourglass-half me-2"></i>
        <div>
            <strong>دفعة معلقة!</strong> هذه الدفعة في انتظار التأكيد
        </div>
    </div>
{% elif payment.status == 'failed' %}
    <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
        <i class="fas fa-times-circle me-2"></i>
        <div>
            <strong>دفعة فاشلة!</strong> فشلت معالجة هذه الدفعة
        </div>
    </div>
{% endif %}

<div class="row">
    <!-- Payment Information -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow-custom">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-credit-card text-primary me-2"></i>
                    معلومات الدفعة
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">رقم الدفعة</label>
                        <p class="fw-bold mb-0">#{{ payment.id }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">رقم الإيصال</label>
                        <p class="fw-bold mb-0">{{ payment.receipt_number|default:"غير محدد" }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">رقم المعاملة</label>
                        <p class="fw-bold mb-0">{{ payment.transaction_id|default:"غير محدد" }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">المبلغ</label>
                        <p class="fw-bold mb-0 text-success">{{ payment.amount }} درهم</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">طريقة الدفع</label>
                        <span class="badge 
                            {% if payment.payment_method == 'paytabs' %}bg-primary
                            {% elif payment.payment_method == 'cash' %}bg-warning text-dark
                            {% else %}bg-success{% endif %}">
                            <i class="fas 
                                {% if payment.payment_method == 'cash' %}fa-money-bill-wave
                                {% else %}fa-credit-card{% endif %}"></i>
                            {{ payment.get_payment_method_display }}
                        </span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">حالة الدفعة</label>
                        <span class="badge 
                            {% if payment.status == 'paid' %}bg-success
                            {% elif payment.status == 'pending' %}bg-warning
                            {% elif payment.status == 'failed' %}bg-danger
                            {% elif payment.status == 'refunded' %}bg-info
                            {% else %}bg-secondary{% endif %}">
                            <i class="fas 
                                {% if payment.status == 'paid' %}fa-check-circle
                                {% elif payment.status == 'pending' %}fa-hourglass-half
                                {% elif payment.status == 'failed' %}fa-times-circle
                                {% elif payment.status == 'refunded' %}fa-undo
                                {% else %}fa-clock{% endif %}"></i>
                            {{ payment.get_status_display }}
                        </span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">تاريخ الإنشاء</label>
                        <p class="fw-bold mb-0">{{ payment.created_at|date:"d يناير Y - H:i" }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">تاريخ التحديث</label>
                        <p class="fw-bold mb-0">{{ payment.updated_at|date:"d يناير Y - H:i" }}</p>
                    </div>
                    {% if payment.processed_by %}
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">معالج الدفعة</label>
                        <p class="fw-bold mb-0">{{ payment.processed_by.get_full_name|default:payment.processed_by.username }}</p>
                    </div>
                    {% endif %}
                </div>
                
                {% if payment.notes %}
                <div class="mt-3">
                    <label class="text-muted mb-1">ملاحظات الدفعة</label>
                    <div class="alert alert-info">
                        <i class="fas fa-sticky-note me-2"></i>
                        {{ payment.notes }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Request Information -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow-custom">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt text-info me-2"></i>
                    معلومات الطلب
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="text-muted mb-1">الرقم المرجعي</label>
                    <p class="fw-bold mb-0">
                        <a href="{% url 'requests:detail' payment.request.id %}" class="text-decoration-none">
                            {{ payment.request.reference_number }}
                        </a>
                    </p>
                </div>
                <div class="mb-3">
                    <label class="text-muted mb-1">اسم العميل</label>
                    <p class="fw-bold mb-0">{{ payment.request.customer.full_name }}</p>
                </div>
                <div class="mb-3">
                    <label class="text-muted mb-1">نوع الخدمة</label>
                    <p class="fw-bold mb-0">
                        {% if payment.request.request_type %}
                            {{ payment.request.request_type.name_arabic }}
                        {% else %}
                            غير محدد
                        {% endif %}
                    </p>
                </div>
                <div class="mb-3">
                    <label class="text-muted mb-1">حالة الطلب</label>
                    <span class="badge 
                        {% if payment.request.status == 'paid' %}bg-success
                        {% elif payment.request.status == 'approved' %}bg-success
                        {% elif payment.request.status == 'pending_payment' %}bg-warning
                        {% elif payment.request.status == 'rejected' %}bg-danger
                        {% else %}bg-secondary{% endif %}">
                        {{ payment.request.get_status_display }}
                    </span>
                </div>
                <div class="mb-3">
                    <label class="text-muted mb-1">تاريخ إنشاء الطلب</label>
                    <p class="fw-bold mb-0">{{ payment.request.created_at|date:"d يناير Y" }}</p>
                </div>
                
                <div class="d-grid gap-2">
                    <a href="{% url 'requests:detail' payment.request.id %}" class="btn btn-outline-primary">
                        <i class="fas fa-eye me-1"></i>
                        عرض تفاصيل الطلب
                    </a>
                    {% if payment.status == 'pending' %}
                        <button class="btn btn-success" onclick="confirmPayment()">
                            <i class="fas fa-check me-1"></i>
                            تأكيد الدفعة
                        </button>
                        <button class="btn btn-danger" onclick="cancelPayment()">
                            <i class="fas fa-times me-1"></i>
                            إلغاء الدفعة
                        </button>
                    {% elif payment.status == 'failed' %}
                        <button class="btn btn-warning" onclick="retryPayment()">
                            <i class="fas fa-redo me-1"></i>
                            إعادة المحاولة
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow-custom mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt text-warning me-2"></i>
                    إجراءات سريعة
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if payment.status == 'paid' %}
                        <button class="btn btn-outline-success" onclick="sendEmail()">
                            <i class="fas fa-envelope me-1"></i>
                            إرسال إيصال بالبريد
                        </button>
                    {% endif %}
                    <button class="btn btn-outline-info" onclick="contactCustomer()">
                        <i class="fas fa-phone me-1"></i>
                        الاتصال بالعميل
                    </button>
                    <button class="btn btn-outline-secondary" onclick="window.print()">
                        <i class="fas fa-print me-1"></i>
                        طباعة الصفحة
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modals -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    تأكيد الدفعة
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>تحذير:</strong> هل أنت متأكد من تأكيد هذه الدفعة المعلقة؟
                </div>
                <p>الدفعة رقم: {{ payment.id }}</p>
                <p>المبلغ: {{ payment.amount }} درهم</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    إلغاء
                </button>
                <form method="post" action="{% url 'payments:confirm' %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="payment_id" value="{{ payment.id }}">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>
                        تأكيد الدفعة
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelModalLabel">
                    <i class="fas fa-times-circle text-danger me-2"></i>
                    إلغاء الدفعة
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>تحذير:</strong> هل أنت متأكد من إلغاء هذه الدفعة المعلقة؟
                </div>
                <p>الدفعة رقم: {{ payment.id }}</p>
                <p>المبلغ: {{ payment.amount }} درهم</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    إلغاء
                </button>
                <form method="post" action="{% url 'payments:cancel' %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="payment_id" value="{{ payment.id }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>
                        إلغاء الدفعة
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript functions
function printReceipt() {
    window.open(`/payments/{{ payment.id }}/receipt/`, '_blank');
}

function confirmPayment() {
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

function cancelPayment() {
    const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
    modal.show();
}

function retryPayment() {
    if (confirm('هل تريد إعادة محاولة هذه الدفعة الفاشلة؟')) {
        window.location.href = `/payments/{{ payment.id }}/retry/`;
    }
}

function sendEmail() {
    window.location.href = `/payments/{{ payment.id }}/send-email/`;
}

function contactCustomer() {
    window.location.href = `/clients/{{ payment.request.customer.id }}/`;
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.main-content');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock content %}