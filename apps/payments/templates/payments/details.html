{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Include messages component -->
{% include 'message.html' %}

<!-- Page Title -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-0">
            <i class="fas fa-receipt me-2 text-primary"></i>
            تفاصيل الدفعة
        </h2>
        <p class="text-muted mb-0">رقم الإيصال: {{ payment.receipt_number|default:payment.transaction_id|default:"غير محدد" }}</p>
    </div>
    <div class="btn-group" role="group">
        <a href="{% url 'payments:list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-right me-1"></i>
            رجوع للقائمة
        </a>
        <a href="{% url 'requests:detail' payment.request.id %}" class="btn btn-outline-primary">
            <i class="fas fa-eye me-1"></i>
            عرض الطلب
        </a>
        {% if payment.status == 'paid' %}
            <a href="{% url 'payments:receipt' payment.id %}" class="btn btn-success" target="_blank">
                <i class="fas fa-print me-1"></i>
                طباعة الإيصال
            </a>
        {% endif %}
    </div>
</div>

<!-- Payment Information -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card shadow-custom">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    معلومات الدفعة
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">رقم الإيصال</label>
                        <p class="fw-bold mb-0">{{ payment.receipt_number|default:"غير محدد" }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">رقم المعاملة</label>
                        <p class="fw-bold mb-0">{{ payment.transaction_id|default:"غير محدد" }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">المبلغ</label>
                        <p class="fw-bold mb-0 text-success">{{ payment.amount }} درهم</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">طريقة الدفع</label>
                        <p class="fw-bold mb-0">
                            <span class="badge 
                                {% if payment.payment_method == 'paytabs' %}bg-primary
                                {% elif payment.payment_method == 'cash' %}bg-warning text-dark
                                {% else %}bg-success{% endif %}">
                                <i class="fas 
                                    {% if payment.payment_method == 'cash' %}fa-money-bill-wave
                                    {% else %}fa-credit-card{% endif %}"></i>
                                {{ payment.get_payment_method_display }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">الحالة</label>
                        <p class="fw-bold mb-0">
                            <span class="badge 
                                {% if payment.status == 'paid' %}bg-success
                                {% elif payment.status == 'pending' %}bg-warning
                                {% elif payment.status == 'failed' %}bg-danger
                                {% elif payment.status == 'cancelled' %}bg-secondary
                                {% else %}bg-info{% endif %}">
                                <i class="fas 
                                    {% if payment.status == 'paid' %}fa-check-circle
                                    {% elif payment.status == 'pending' %}fa-hourglass-half
                                    {% elif payment.status == 'failed' %}fa-times-circle
                                    {% elif payment.status == 'cancelled' %}fa-ban
                                    {% else %}fa-clock{% endif %}"></i>
                                {{ payment.get_status_display }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="text-muted mb-1">تاريخ الدفع</label>
                        <p class="fw-bold mb-0">{{ payment.created_at|date:"d يناير Y - H:i" }}</p>
                    </div>
                    {% if payment.notes %}
                    <div class="col-12 mb-3">
                        <label class="text-muted mb-1">ملاحظات</label>
                        <p class="fw-bold mb-0">{{ payment.notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card shadow-custom">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt text-info me-2"></i>
                    معلومات الطلب المرتبط
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="text-muted mb-1">الرقم المرجعي</label>
                    <p class="fw-bold mb-0">{{ payment.request.reference_number }}</p>
                </div>
                <div class="mb-3">
                    <label class="text-muted mb-1">العميل</label>
                    <p class="fw-bold mb-0">{{ payment.request.customer.full_name }}</p>
                </div>
                <div class="mb-3">
                    <label class="text-muted mb-1">نوع الطلب</label>
                    <p class="fw-bold mb-0">
                        {% if payment.request.request_type %}
                            {{ payment.request.request_type.name_arabic }}
                        {% else %}
                            غير محدد
                        {% endif %}
                    </p>
                </div>
                <div class="mb-3">
                    <label class="text-muted mb-1">حالة الطلب</label>
                    <p class="fw-bold mb-0">
                        <span class="badge 
                            {% if payment.request.status == 'new' %}bg-primary
                            {% elif payment.request.status == 'in_review' %}bg-warning
                            {% elif payment.request.status == 'approved' %}bg-success
                            {% elif payment.request.status == 'completed' %}bg-info
                            {% elif payment.request.status == 'paid' %}bg-success
                            {% elif payment.request.status == 'rejected' %}bg-danger
                            {% elif payment.request.status == 'cancelled' %}bg-secondary
                            {% else %}bg-light text-dark{% endif %}">
                            {{ payment.request.get_status_display }}
                        </span>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Actions Card -->
        <div class="card shadow-custom mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs text-warning me-2"></i>
                    الإجراءات
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if payment.status == 'pending' %}
                        <button class="btn btn-success" onclick="confirmPayment({{ payment.id }})">
                            <i class="fas fa-check me-2"></i>
                            تأكيد الدفعة
                        </button>
                        <button class="btn btn-danger" onclick="cancelPayment({{ payment.id }})">
                            <i class="fas fa-times me-2"></i>
                            إلغاء الدفعة
                        </button>
                    {% elif payment.status == 'failed' %}
                        <button class="btn btn-warning" onclick="retryPayment({{ payment.id }})">
                            <i class="fas fa-redo me-2"></i>
                            إعادة المحاولة
                        </button>
                    {% elif payment.status == 'paid' %}
                        <button class="btn btn-info" onclick="sendPaymentEmail({{ payment.id }})">
                            <i class="fas fa-envelope me-2"></i>
                            إرسال بالبريد
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modals -->
<div class="modal fade" id="confirmPaymentModal" tabindex="-1" aria-labelledby="confirmPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmPaymentModalLabel">تأكيد الدفعة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>هل تريد تأكيد هذه الدفعة المعلقة؟</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    سيتم تحديث حالة الطلب إلى "مدفوع" بعد التأكيد.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-success" id="confirmPaymentBtn">تأكيد الدفعة</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cancelPaymentModal" tabindex="-1" aria-labelledby="cancelPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelPaymentModalLabel">إلغاء الدفعة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>هل تريد إلغاء هذه الدفعة المعلقة؟</p>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    لا يمكن التراجع عن هذا الإجراء.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-danger" id="cancelPaymentBtn">إلغاء الدفعة</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="retryPaymentModal" tabindex="-1" aria-labelledby="retryPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="retryPaymentModalLabel">إعادة محاولة الدفعة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>هل تريد إعادة محاولة هذه الدفعة الفاشلة؟</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    سيتم إعادة معالجة الدفعة مع نفس البيانات.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-warning" id="retryPaymentBtn">إعادة المحاولة</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPaymentId = null;

function confirmPayment(paymentId) {
    currentPaymentId = paymentId;
    const modal = new bootstrap.Modal(document.getElementById('confirmPaymentModal'));
    modal.show();
}

function cancelPayment(paymentId) {
    currentPaymentId = paymentId;
    const modal = new bootstrap.Modal(document.getElementById('cancelPaymentModal'));
    modal.show();
}

function retryPayment(paymentId) {
    currentPaymentId = paymentId;
    const modal = new bootstrap.Modal(document.getElementById('retryPaymentModal'));
    modal.show();
}

function sendPaymentEmail(paymentId) {
    if (confirm('هل تريد إرسال إيصال الدفع بالبريد الإلكتروني للعميل؟')) {
        fetch(`/payments/${paymentId}/send-email/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('تم إرسال الإيصال بالبريد الإلكتروني بنجاح!', 'success');
            } else {
                showAlert('حدث خطأ أثناء إرسال البريد الإلكتروني', 'error');
            }
        })
        .catch(error => {
            showAlert('حدث خطأ أثناء إرسال البريد الإلكتروني', 'error');
        });
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.main-content');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Modal event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Add CSRF token to page if not exists
    if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            document.body.appendChild(csrfInput);
        }
    }
    
    document.getElementById('confirmPaymentBtn').addEventListener('click', function() {
        if (currentPaymentId) {
            performConfirmPayment(currentPaymentId);
        }
    });
    
    document.getElementById('cancelPaymentBtn').addEventListener('click', function() {
        if (currentPaymentId) {
            performCancelPayment(currentPaymentId);
        }
    });
    
    document.getElementById('retryPaymentBtn').addEventListener('click', function() {
        if (currentPaymentId) {
            performRetryPayment(currentPaymentId);
        }
    });
});

function performConfirmPayment(paymentId) {
    fetch(`/payments/${paymentId}/confirm/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('✅ تم تأكيد الدفعة بنجاح!', 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert('❌ حدث خطأ أثناء تأكيد الدفعة', 'error');
        }
    })
    .catch(error => {
        showAlert('❌ حدث خطأ أثناء تأكيد الدفعة', 'error');
    });
    
    bootstrap.Modal.getInstance(document.getElementById('confirmPaymentModal')).hide();
}

function performCancelPayment(paymentId) {
    fetch(`/payments/${paymentId}/cancel/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('✅ تم إلغاء الدفعة بنجاح!', 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert('❌ حدث خطأ أثناء إلغاء الدفعة', 'error');
        }
    })
    .catch(error => {
        showAlert('❌ حدث خطأ أثناء إلغاء الدفعة', 'error');
    });
    
    bootstrap.Modal.getInstance(document.getElementById('cancelPaymentModal')).hide();
}

function performRetryPayment(paymentId) {
    fetch(`/payments/${paymentId}/retry/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('✅ تم إعادة محاولة الدفعة بنجاح!', 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert('❌ حدث خطأ أثناء إعادة محاولة الدفعة', 'error');
        }
    })
    .catch(error => {
        showAlert('❌ حدث خطأ أثناء إعادة محاولة الدفعة', 'error');
    });
    
    bootstrap.Modal.getInstance(document.getElementById('retryPaymentModal')).hide();
}
</script>
{% endblock content %}
