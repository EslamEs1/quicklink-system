<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محادثات WhatsApp Business - Quick Link System</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/bootstrap.rtl.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/custom.css">
</head>
<body>
    <!-- Header -->
    <div id="header-placeholder"></div>

    <!-- Sidebar -->
    <div id="sidebar-placeholder"></div>

    <!-- Main Content -->
    <div class="main-content-wrapper">
        <main class="main-content">
            <!-- رأس الصفحة -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="page-title mb-2">
                        <i class="fab fa-whatsapp text-success me-2"></i>
                        محادثات WhatsApp Business
                    </h2>
                    <p class="page-subtitle text-muted">واجهة دردشة آمنة بدون إظهار الأرقام</p>
                </div>
                <div>
                    <a href="customers.html" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-right me-1"></i>
                        رجوع للعملاء
                    </a>
                </div>
            </div>

            <!-- تنبيه الأمان -->
            <div class="alert alert-success mb-4">
                <i class="fas fa-shield-alt me-2"></i>
                <strong>محادثات آمنة:</strong> جميع المحادثات مشفرة. أرقام العملاء مخفية. كل رسالة مسجلة في سجل التدقيق.
            </div>

            <!-- Chat Container -->
            <div class="chat-container">
                <!-- Sidebar - قائمة المحادثات -->
                <div class="chat-sidebar" id="chatSidebar">
                    <div class="p-3 bg-white border-bottom">
                        <input type="text" class="form-control" placeholder="بحث في المحادثات..." id="searchConversations">
                    </div>
                    
                    <!-- محادثة 1 - نشطة -->
                    <div class="conversation-item active" onclick="loadConversation(1)">
                        <div class="d-flex align-items-start">
                            <div class="avatar-circle bg-primary me-2">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <strong>أحمد محمد علي</strong>
                                    <small class="text-muted">10:30 ص</small>
                                </div>
                                <small class="text-muted">شكراً على المتابعة السريعة...</small>
                                <div class="mt-1">
                                    <span class="badge bg-success">متصل</span>
                                    <span class="unread-badge ms-1">2</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- محادثة 2 -->
                    <div class="conversation-item" onclick="loadConversation(2)">
                        <div class="d-flex align-items-start">
                            <div class="avatar-circle bg-warning me-2">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <strong>فاطمة عبدالله</strong>
                                    <small class="text-muted">أمس</small>
                                </div>
                                <small class="text-muted">متى سيكون الطلب جاهز؟</small>
                                <div class="mt-1">
                                    <span class="badge bg-secondary">غير متصل</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- محادثة 3 -->
                    <div class="conversation-item" onclick="loadConversation(3)">
                        <div class="d-flex align-items-start">
                            <div class="avatar-circle bg-info me-2">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <strong>محمد سالم أحمد</strong>
                                    <small class="text-muted">أمس</small>
                                </div>
                                <small class="text-muted">تم استلام الإيصال، شكراً</small>
                            </div>
                        </div>
                    </div>

                    <!-- محادثة 4 -->
                    <div class="conversation-item" onclick="loadConversation(4)">
                        <div class="d-flex align-items-start">
                            <div class="avatar-circle bg-success me-2">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <strong>سارة حسن محمد</strong>
                                    <small class="text-muted">12 يناير</small>
                                </div>
                                <small class="text-muted">هل يمكنني تعديل البيانات؟</small>
                                <div class="mt-1">
                                    <span class="unread-badge">1</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conversation Area -->
                <div class="chat-conversation">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-light me-3 d-md-none" onclick="toggleChatSidebar()">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                            <div class="avatar-circle bg-white text-primary me-3">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h5 class="mb-0" id="chatCustomerName">أحمد محمد علي</h5>
                                <small id="chatCustomerStatus">متصل الآن</small>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-light" onclick="viewCustomerProfile()">
                                <i class="fas fa-user-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-light" onclick="viewRequestDetails()">
                                <i class="fas fa-file-alt"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Messages Area -->
                    <div class="chat-messages" id="chatMessages">
                        <!-- رسالة مستلمة -->
                        <div class="message received">
                            <div class="avatar-circle bg-primary" style="width: 35px; height: 35px; font-size: 0.8rem;">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="message-bubble">
                                <div>السلام عليكم، أريد الاستفسار عن حالة الطلب</div>
                                <div class="message-time">9:45 ص</div>
                            </div>
                        </div>

                        <!-- رسالة مرسلة -->
                        <div class="message sent">
                            <div class="avatar-circle bg-success" style="width: 35px; height: 35px; font-size: 0.8rem;">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="message-bubble">
                                <div>وعليكم السلام، طلبك قيد المراجعة الآن</div>
                                <div class="message-time">9:50 ص</div>
                            </div>
                        </div>

                        <!-- رسالة مستلمة -->
                        <div class="message received">
                            <div class="avatar-circle bg-primary" style="width: 35px; height: 35px; font-size: 0.8rem;">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="message-bubble">
                                <div>كم المدة المتوقعة للانتهاء؟</div>
                                <div class="message-time">9:55 ص</div>
                            </div>
                        </div>

                        <!-- رسالة مرسلة -->
                        <div class="message sent">
                            <div class="avatar-circle bg-success" style="width: 35px; height: 35px; font-size: 0.8rem;">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="message-bubble">
                                <div>عادة يستغرق من 24-48 ساعة عمل</div>
                                <div class="message-time">10:00 ص</div>
                            </div>
                        </div>

                        <!-- رسالة مستلمة -->
                        <div class="message received">
                            <div class="avatar-circle bg-primary" style="width: 35px; height: 35px; font-size: 0.8rem;">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="message-bubble">
                                <div>ممتاز، شكراً على المتابعة السريعة 👍</div>
                                <div class="message-time">10:30 ص</div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="chat-input">
                        <form id="messageForm" onsubmit="return sendMessage(event)">
                            <div class="input-group">
                                <button type="button" class="btn btn-outline-secondary" onclick="attachFile()">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="attachImage()">
                                    <i class="fas fa-image"></i>
                                </button>
                                <input type="text" class="form-control" id="messageInput" placeholder="اكتب رسالتك هنا..." required>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </main>

        <!-- Footer -->
        <div class="footer-wrapper">
            <div id="footer-placeholder"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-placeholder"></div>

    <!-- Bootstrap JS -->
    <script src="assets/js/popper.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    
    <!-- Custom JS -->
    <script src="assets/js/custom.js"></script>

    <script>
        // تحميل المكونات
        document.addEventListener('DOMContentLoaded', async function() {
            await Promise.all([
                fetch('components/header.html').then(r => r.text()).then(html => {
                    document.getElementById('header-placeholder').innerHTML = html;
                }),
                fetch('components/sidebar.html').then(r => r.text()).then(html => {
                    document.getElementById('sidebar-placeholder').innerHTML = html;
                }),
                fetch('components/footer.html').then(r => r.text()).then(html => {
                    document.getElementById('footer-placeholder').innerHTML = html;
                }),
                fetch('components/confirm-modal.html').then(r => r.text()).then(html => {
                    document.getElementById('modal-placeholder').innerHTML = html;
                })
            ]);

            // تحميل المحادثة من الرابط
            const customerId = new URLSearchParams(window.location.search).get('customer');
            if (customerId) {
                loadConversation(customerId);
            }

            // التمرير إلى آخر رسالة
            scrollToBottom();
        });

        // تحميل محادثة
        function loadConversation(id) {
            console.log('تحميل المحادثة:', id);
            // هنا يتم تحميل المحادثة من السيرفر
            
            // تحديث النشط
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // إخفاء القائمة في الموبايل
            if (window.innerWidth <= 768) {
                document.getElementById('chatSidebar').classList.remove('show');
            }
        }

        // إرسال رسالة
        function sendMessage(event) {
            event.preventDefault();
            
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (messageText === '') return false;

            // إضافة الرسالة للواجهة
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ar-AE', {hour: '2-digit', minute: '2-digit'});
            
            const messageHTML = `
                <div class="message sent">
                    <div class="avatar-circle bg-success" style="width: 35px; height: 35px; font-size: 0.8rem;">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="message-bubble">
                        <div>${messageText}</div>
                        <div class="message-time">${timeStr}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('chatMessages').insertAdjacentHTML('beforeend', messageHTML);
            
            // مسح المدخل
            messageInput.value = '';
            
            // التمرير إلى آخر رسالة
            scrollToBottom();
            
            // هنا يتم إرسال الرسالة للسيرفر
            
            return false;
        }

        // إرفاق ملف
        function attachFile() {
            showSuccess('اختيار ملف للإرفاق... يمكنك إرفاق PDF, DOC, XLS (حد أقصى 10 MB)');
        }

        // إرفاق صورة
        function attachImage() {
            showSuccess('اختيار صورة للإرفاق... يمكنك إرفاق JPG, PNG (حد أقصى 5 MB)');
        }

        // عرض ملف العميل
        function viewCustomerProfile() {
            const customerId = new URLSearchParams(window.location.search).get('customer') || '1';
            window.location.href = `customer-details.html?id=${customerId}`;
        }

        // عرض تفاصيل الطلب
        function viewRequestDetails() {
            showSuccess('جارٍ فتح تفاصيل آخر طلب للعميل...');
        }

        // Toggle sidebar في الموبايل
        function toggleChatSidebar() {
            document.getElementById('chatSidebar').classList.toggle('show');
        }

        // التمرير إلى آخر رسالة
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // البحث في المحادثات
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchConversations');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const conversations = document.querySelectorAll('.conversation-item');
                    
                    conversations.forEach(conv => {
                        const text = conv.textContent.toLowerCase();
                        conv.style.display = text.includes(searchTerm) ? 'block' : 'none';
                    });
                });
            }
        });
    </script>
</body>
</html>

