<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إنشاء طلب جديد - Quick Link System</title>
    
    <!-- Bootstrap CSS -->
    <link href="assets/css/bootstrap.rtl.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link href="assets/css/custom.css" rel="stylesheet">
    
    <!-- Custom Font -->
    <link href="assets/fonts/JF-Flat-Regular.ttf" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <div id="header-placeholder"></div>
    
    <!-- Sidebar -->
    <div id="sidebar-placeholder"></div>
    
    <!-- Main Content -->
    <div class="main-content-wrapper">
        <main class="main-content">
            <!-- Progress Steps -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-custom">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <div class="step-item active">
                                            <div class="step-number">1</div>
                                            <div class="step-title">بيانات العميل</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="step-item">
                                            <div class="step-number">2</div>
                                            <div class="step-title">اختيار القالب</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="step-item">
                                            <div class="step-number">3</div>
                                            <div class="step-title">مراجعة البيانات</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="step-item">
                                            <div class="step-number">4</div>
                                            <div class="step-title">الدفع والإرسال</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Form -->
                <form id="createRequestForm" class="needs-validation" novalidate>
                    <!-- Step 1: Customer Information -->
                    <div class="step-content" id="step1">
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="card shadow-custom">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-user me-2"></i>
                                            بيانات العميل الأساسية
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <!-- Reference Number -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الرقم المرجعي للطلب</label>
                                                <input type="text" class="form-control" id="referenceNumber" 
                                                       data-auto-reference readonly>
                                            </div>
                                            
                                            <!-- Request Date -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تاريخ الطلب</label>
                                                <input type="date" class="form-control" id="requestDate" 
                                                       value="" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Customer Name -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الاسم الكامل للعميل <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="customerName" 
                                                       placeholder="أدخل الاسم الكامل" required>
                                            </div>
                                            
                                            <!-- Confirm Name -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تأكيد الاسم <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="confirmName" 
                                                       placeholder="أعد كتابة الاسم للتأكيد" required>
                                                <div class="form-text text-danger" id="nameMatchError" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    الأسماء غير متطابقة!
                                                </div>
                                                <div class="form-text text-success" id="nameMatchSuccess" style="display: none;">
                                                    <i class="fas fa-check-circle"></i>
                                                    الأسماء متطابقة ✓
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Emirates ID -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">رقم الهوية الإماراتية <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="emiratesId" 
                                                       placeholder="784-XXXX-XXXXXXX-X" maxlength="18" required>
                                                <div class="form-text">يجب أن يبدأ بـ 784 ويتكون من 15 رقم</div>
                                                <div class="form-text text-danger" id="idFormatError" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    تنسيق خاطئ! يجب أن يكون: 784-XXXX-XXXXXXX-X
                                                </div>
                                                <div class="form-text text-success" id="idFormatSuccess" style="display: none;">
                                                    <i class="fas fa-check-circle"></i>
                                                    تنسيق صحيح ✓
                                                </div>
                                                <div class="form-text text-warning" id="idConflictWarning" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    تحذير: نفس الاسم مع هوية مختلفة!
                                                </div>
                                            </div>
                                            
                                            <!-- Date of Birth -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">تاريخ الميلاد <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="dateOfBirth" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Nationality -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">الجنسية <span class="text-danger">*</span></label>
                                                <select class="form-control" id="nationality" required>
                                                    <option value="">اختر الجنسية</option>
                                                    <option value="emirati">إماراتي</option>
                                                    <option value="saudi">سعودي</option>
                                                    <option value="egyptian">مصري</option>
                                                    <option value="indian">هندي</option>
                                                    <option value="pakistani">باكستاني</option>
                                                    <option value="other">أخرى</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Mobile Number -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">رقم الجوال <span class="text-danger">*</span></label>
                                                <input type="tel" class="form-control" id="mobileNumber" 
                                                       placeholder="+971-XX-XXX-XXXX" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Email -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">البريد الإلكتروني</label>
                                                <input type="email" class="form-control" id="email" 
                                                       placeholder="example@email.com">
                                            </div>
                                            
                                            <!-- Request Type -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">نوع الطلب <span class="text-danger">*</span></label>
                                                <select class="form-control" id="requestType" required>
                                                    <option value="">اختر نوع الطلب</option>
                                                    <option value="paytabs-link">ربط حساب PayTabs</option>
                                                    <option value="payment-gateway">بوابة دفع إلكترونية</option>
                                                    <option value="bank-integration">تكامل بنكي</option>
                                                    <option value="other">أخرى</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ID Upload Section -->
                            <div class="col-lg-4">
                                <div class="card shadow-custom">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-camera me-2"></i>
                                            صورة الهوية
                                        </h5>
                                    </div>
                                    <div class="card-body text-center">
                                        <div class="upload-area" id="uploadArea">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">اسحب وأفلت صورة الهوية هنا</p>
                                            <p class="text-muted small">أو انقر للاختيار</p>
                                            <input type="file" id="idImage" accept="image/*" class="d-none" required>
                                        </div>
                                        <div class="preview-area d-none" id="previewArea">
                                            <img id="imagePreview" class="img-fluid rounded mb-2" style="max-height: 200px;">
                                            <button type="button" class="btn btn-sm btn-danger" onclick="removeImage()">
                                                <i class="fas fa-trash me-1"></i>إزالة
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Validation Checklist -->
                                <div class="card shadow-custom mt-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-check-circle me-2"></i>
                                            قائمة التحقق
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="checkName" disabled>
                                            <label class="form-check-label" for="checkName">
                                                تطابق الأسماء
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="checkId" disabled>
                                            <label class="form-check-label" for="checkId">
                                                صحة رقم الهوية (784-XXXX-XXXXXXX-X)
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="checkImage" disabled>
                                            <label class="form-check-label" for="checkImage">
                                                رفع صورة الهوية (إجباري)
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="checkTemplate" disabled>
                                            <label class="form-check-label" for="checkTemplate">
                                                اختيار القالب القانوني
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="checkData" disabled>
                                            <label class="form-check-label" for="checkData">
                                                اكتمال جميع البيانات
                                            </label>
                                        </div>
                                        <hr>
                                        <div class="text-center">
                                            <button type="button" class="btn btn-success w-100" id="createDraftBtn" disabled>
                                                <i class="fas fa-file-alt me-1"></i>
                                                إنشاء درافت
                                            </button>
                                            <small class="text-muted d-block mt-2">
                                                يجب إكمال جميع عناصر التحقق أولاً
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Template Selection -->
                    <div class="step-content d-none" id="step2">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-alt me-2"></i>
                                    اختيار القالب القانوني
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">نوع التفويض <span class="text-danger">*</span></label>
                                        <select class="form-control" id="authorizationType" required>
                                            <option value="">اختر نوع التفويض</option>
                                            <option value="payment-authorization">تفويض دفع (قالب مركزي)</option>
                                            <option value="account-management">إدارة الحساب (قالب مركزي)</option>
                                            <option value="financial-operations">العمليات المالية (قالب مركزي)</option>
                                            <option value="general-authorization">تفويض عام (قالب مركزي)</option>
                                        </select>
                                        <div class="form-text text-info">
                                            <i class="fas fa-info-circle"></i>
                                            القوالب المركزية فقط - لا يُسمح بإنشاء قوالب خارجية
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">إصدار القالب <span class="text-danger">*</span></label>
                                        <select class="form-control" id="templateVersion" required>
                                            <option value="">اختر الإصدار</option>
                                            <option value="v1.0">الإصدار 1.0 (الحالي - محدث)</option>
                                            <option value="v0.9">الإصدار 0.9 (منتهي الصلاحية)</option>
                                        </select>
                                        <div class="form-text text-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            يُنصح بالإصدار الحالي دائماً
                                        </div>
                                    </div>
                                </div>

                                <!-- Template Preview -->
                                <div class="template-preview" id="templatePreview">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        اختر نوع التفويض لعرض القالب
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Review -->
                    <div class="step-content d-none" id="step3">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-eye me-2"></i>
                                    مراجعة البيانات قبل الإرسال
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>بيانات العميل:</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>الاسم:</strong></td><td id="reviewName">-</td></tr>
                                            <tr><td><strong>الهوية:</strong></td><td id="reviewId">-</td></tr>
                                            <tr><td><strong>تاريخ الميلاد:</strong></td><td id="reviewBirth">-</td></tr>
                                            <tr><td><strong>الجنسية:</strong></td><td id="reviewNationality">-</td></tr>
                                            <tr><td><strong>الجوال:</strong></td><td id="reviewMobile">-</td></tr>
                                            <tr><td><strong>البريد:</strong></td><td id="reviewEmail">-</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>تفاصيل الطلب:</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>الرقم المرجعي:</strong></td><td id="reviewReference">-</td></tr>
                                            <tr><td><strong>نوع الطلب:</strong></td><td id="reviewType">-</td></tr>
                                            <tr><td><strong>نوع التفويض:</strong></td><td id="reviewAuthType">-</td></tr>
                                            <tr><td><strong>إصدار القالب:</strong></td><td id="reviewVersion">-</td></tr>
                                            <tr><td><strong>تاريخ الطلب:</strong></td><td id="reviewDate">-</td></tr>
                                            <tr><td><strong>صورة الهوية:</strong></td><td id="reviewImage">-</td></tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Payment -->
                    <div class="step-content d-none" id="step4">
                        <div class="card shadow-custom">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-credit-card me-2"></i>
                                    الدفع والرسوم
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>تفاصيل الرسوم:</h6>
                                        <table class="table">
                                            <tr>
                                                <td>رسوم المعالجة:</td>
                                                <td class="text-end"><strong>250 درهم</strong></td>
                                            </tr>
                                            <tr>
                                                <td>رسوم القالب القانوني:</td>
                                                <td class="text-end"><strong>150 درهم</strong></td>
                                            </tr>
                                            <tr>
                                                <td>الضريبة (5%):</td>
                                                <td class="text-end"><strong>20 درهم</strong></td>
                                            </tr>
                                            <tr class="table-active">
                                                <td><strong>المجموع:</strong></td>
                                                <td class="text-end"><strong class="text-primary">420 درهم</strong></td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>طرق الدفع (إجباري):</h6>
                                        <div class="payment-methods">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="paymentMethod" 
                                                       id="paytabs" value="paytabs" checked>
                                                <label class="form-check-label" for="paytabs">
                                                    <i class="fas fa-credit-card me-2"></i>
                                                    دفع إلكتروني (PayTabs) - <strong>متاح بالفعل</strong>
                                                </label>
                                                <div class="form-text text-success">
                                                    <i class="fas fa-check-circle"></i>
                                                    رابط آمن للدفع المركزي
                                                </div>
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="paymentMethod" 
                                                       id="cash" value="cash">
                                                <label class="form-check-label" for="cash">
                                                    <i class="fas fa-money-bill-wave me-2"></i>
                                                    دفع نقدي (مع إيصال)
                                                </label>
                                                <div class="form-text text-info">
                                                    <i class="fas fa-info-circle"></i>
                                                    يُسجل مع رقم الإيصال فقط
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>مهم:</strong> لا يمكن إغلاق الطلب بدون تأكيد الدفع
                                        </div>
                                        
                                        <div class="cash-receipt d-none" id="cashReceipt">
                                            <label class="form-label">رقم الإيصال:</label>
                                            <input type="text" class="form-control" id="receiptNumber" 
                                                   placeholder="أدخل رقم الإيصال">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card shadow-custom">
                                <div class="card-body text-center">
                                    <button type="button" class="btn btn-secondary me-2" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                                        <i class="fas fa-arrow-right me-1"></i>
                                        السابق
                                    </button>
                                    
                                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">
                                        التالي
                                        <i class="fas fa-arrow-left me-1"></i>
                                    </button>
                                    
                                    <button type="submit" class="btn btn-success d-none" id="submitBtn">
                                        <i class="fas fa-check me-1"></i>
                                        إنشاء الطلب
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
        </main>
    </div>

    <!-- Footer -->
    <div class="footer-wrapper">
        <div id="footer-placeholder"></div>
    </div>

    <!-- Modals -->
    <div id="modal-placeholder"></div>

    <!-- Bootstrap JS -->
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="assets/js/custom.js"></script>
    
    <!-- Form-specific JavaScript -->
    <script>
        let currentStep = 1;
        const totalSteps = 4;

        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            setupImageUpload();
            setupPaymentMethods();
            setupValidation();
        });

        function initializeForm() {
            // Set today's date
            document.getElementById('requestDate').value = new Date().toISOString().split('T')[0];
            
            // Generate reference number
            document.getElementById('referenceNumber').value = generateReferenceNumber();
        }

        function setupImageUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('idImage');
            const previewArea = document.getElementById('previewArea');
            const imagePreview = document.getElementById('imagePreview');

            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            function handleFileSelect(file) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        uploadArea.classList.add('d-none');
                        previewArea.classList.remove('d-none');
                        updateChecklist();
                    };
                    reader.readAsDataURL(file);
                } else {
                    showError('يرجى اختيار ملف صورة صالح');
                }
            }
        }

        function removeImage() {
            document.getElementById('idImage').value = '';
            document.getElementById('uploadArea').classList.remove('d-none');
            document.getElementById('previewArea').classList.add('d-none');
            updateChecklist();
        }

        function setupPaymentMethods() {
            const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
            const cashReceipt = document.getElementById('cashReceipt');

            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    if (this.value === 'cash') {
                        cashReceipt.classList.remove('d-none');
                        document.getElementById('receiptNumber').required = true;
                    } else {
                        cashReceipt.classList.add('d-none');
                        document.getElementById('receiptNumber').required = false;
                    }
                });
            });
        }

        function changeStep(direction) {
            const steps = document.querySelectorAll('.step-content');
            const stepNumbers = document.querySelectorAll('.step-number');
            
            if (direction > 0 && validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    currentStep++;
                }
            } else if (direction < 0) {
                if (currentStep > 1) {
                    currentStep--;
                }
            }

            // Update step content
            steps.forEach((step, index) => {
                if (index + 1 === currentStep) {
                    step.classList.remove('d-none');
                } else {
                    step.classList.add('d-none');
                }
            });

            // Update step numbers
            stepNumbers.forEach((number, index) => {
                if (index + 1 <= currentStep) {
                    number.classList.add('bg-primary', 'text-white');
                    number.classList.remove('bg-light');
                } else {
                    number.classList.remove('bg-primary', 'text-white');
                    number.classList.add('bg-light');
                }
            });

            // Update buttons
            updateButtons();
            
            // Update review data if on step 3
            if (currentStep === 3) {
                updateReviewData();
            }
        }

        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    return validateStep1();
                case 2:
                    return validateStep2();
                case 3:
                    return true; // Review step
                case 4:
                    return validateStep4();
                default:
                    return false;
            }
        }

        function validateStep1() {
            const required = ['customerName', 'confirmName', 'emiratesId', 'dateOfBirth', 'nationality', 'mobileNumber', 'requestType'];
            let isValid = true;

            required.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            // Check image upload
            const imageInput = document.getElementById('idImage');
            if (!imageInput.files.length) {
                showError('يرجى رفع صورة الهوية');
                isValid = false;
            }

            return isValid;
        }

        function validateStep2() {
            const authType = document.getElementById('authorizationType');
            const version = document.getElementById('templateVersion');
            
            if (!authType.value || !version.value) {
                showError('يرجى اختيار نوع التفويض والإصدار');
                return false;
            }
            
            return true;
        }

        function validateStep4() {
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!paymentMethod) {
                showError('يرجى اختيار طريقة الدفع');
                return false;
            }

            if (paymentMethod.value === 'cash') {
                const receiptNumber = document.getElementById('receiptNumber');
                if (!receiptNumber.value.trim()) {
                    showError('يرجى إدخال رقم الإيصال');
                    return false;
                }
            }

            return true;
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');

            prevBtn.style.display = currentStep > 1 ? 'inline-block' : 'none';
            
            if (currentStep === totalSteps) {
                nextBtn.classList.add('d-none');
                submitBtn.classList.remove('d-none');
            } else {
                nextBtn.classList.remove('d-none');
                submitBtn.classList.add('d-none');
            }
        }

        function updateReviewData() {
            document.getElementById('reviewName').textContent = document.getElementById('customerName').value;
            document.getElementById('reviewId').textContent = document.getElementById('emiratesId').value;
            document.getElementById('reviewBirth').textContent = document.getElementById('dateOfBirth').value;
            document.getElementById('reviewNationality').textContent = document.getElementById('nationality').options[document.getElementById('nationality').selectedIndex].text;
            document.getElementById('reviewMobile').textContent = document.getElementById('mobileNumber').value;
            document.getElementById('reviewEmail').textContent = document.getElementById('email').value || 'غير محدد';
            document.getElementById('reviewReference').textContent = document.getElementById('referenceNumber').value;
            document.getElementById('reviewType').textContent = document.getElementById('requestType').options[document.getElementById('requestType').selectedIndex].text;
            document.getElementById('reviewAuthType').textContent = document.getElementById('authorizationType').options[document.getElementById('authorizationType').selectedIndex].text;
            document.getElementById('reviewVersion').textContent = document.getElementById('templateVersion').options[document.getElementById('templateVersion').selectedIndex].text;
            document.getElementById('reviewDate').textContent = document.getElementById('requestDate').value;
            document.getElementById('reviewImage').textContent = document.getElementById('idImage').files.length ? 'تم الرفع' : 'لم يتم الرفع';
        }

        function setupValidation() {
            // التحقق من تطابق الأسماء
            document.getElementById('customerName').addEventListener('input', checkNameMatch);
            document.getElementById('confirmName').addEventListener('input', checkNameMatch);
            
            // التحقق من رقم الهوية
            document.getElementById('emiratesId').addEventListener('input', validateEmiratesId);
            
            // التحقق من اختيار القالب
            document.getElementById('authorizationType').addEventListener('change', checkTemplateSelection);
            document.getElementById('templateVersion').addEventListener('change', checkTemplateSelection);
        }

        function checkNameMatch() {
            const name = document.getElementById('customerName').value;
            const confirmName = document.getElementById('confirmName').value;
            const errorDiv = document.getElementById('nameMatchError');
            const successDiv = document.getElementById('nameMatchSuccess');
            const checkbox = document.getElementById('checkName');
            
            if (name && confirmName) {
                if (name === confirmName) {
                    errorDiv.style.display = 'none';
                    successDiv.style.display = 'block';
                    checkbox.checked = true;
                    checkbox.disabled = false;
                } else {
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    checkbox.checked = false;
                    checkbox.disabled = true;
                }
            } else {
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                checkbox.checked = false;
                checkbox.disabled = true;
            }
            updateCreateDraftButton();
        }

        function validateEmiratesId() {
            const id = document.getElementById('emiratesId').value;
            const errorDiv = document.getElementById('idFormatError');
            const successDiv = document.getElementById('idFormatSuccess');
            const warningDiv = document.getElementById('idConflictWarning');
            const checkbox = document.getElementById('checkId');
            
            const idPattern = /^784-\d{4}-\d{7}-\d{1}$/;
            
            if (id) {
                if (idPattern.test(id)) {
                    errorDiv.style.display = 'none';
                    successDiv.style.display = 'block';
                    checkbox.checked = true;
                    checkbox.disabled = false;
                    
                    // فحص التعارض في الهوية
                    checkIdentityConflict(document.getElementById('customerName').value, id);
                } else {
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                    warningDiv.style.display = 'none';
                    checkbox.checked = false;
                    checkbox.disabled = true;
                }
            } else {
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                warningDiv.style.display = 'none';
                checkbox.checked = false;
                checkbox.disabled = true;
            }
            updateCreateDraftButton();
        }

        function checkIdentityConflict(name, id) {
            // محاكاة فحص التعارض
            if (name === "أحمد محمد علي" && id !== "784-1234-5678901-2") {
                document.getElementById('idConflictWarning').style.display = 'block';
                showWarning('تحذير: اكتشاف اسم مكرر مع هوية مختلفة!');
            } else {
                document.getElementById('idConflictWarning').style.display = 'none';
            }
        }

        function checkTemplateSelection() {
            const authType = document.getElementById('authorizationType').value;
            const version = document.getElementById('templateVersion').value;
            const checkbox = document.getElementById('checkTemplate');
            
            if (authType && version) {
                checkbox.checked = true;
                checkbox.disabled = false;
                
                // تحميل القالب المركزي
                loadCentralTemplate(authType, version);
            } else {
                checkbox.checked = false;
                checkbox.disabled = true;
            }
            updateCreateDraftButton();
        }

        function loadCentralTemplate(type, version) {
            const preview = document.getElementById('templatePreview');
            preview.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>قالب مركزي محمل:</strong> ${type} - ${version}
                    <br>
                    <small>تم تحميل القالب الرسمي والمحدث من القوالب المركزية</small>
                </div>
            `;
        }

        function updateChecklist() {
            const nameMatch = document.getElementById('checkName').checked;
            const idValid = document.getElementById('checkId').checked;
            const imageUploaded = document.getElementById('idImage').files.length > 0;
            const templateSelected = document.getElementById('checkTemplate').checked;
            const dataComplete = validateCurrentStep();

            document.getElementById('checkImage').checked = imageUploaded;
            document.getElementById('checkImage').disabled = !imageUploaded;
            document.getElementById('checkData').checked = dataComplete;
            document.getElementById('checkData').disabled = !dataComplete;
            
            updateCreateDraftButton();
        }

        function updateCreateDraftButton() {
            const allChecks = document.querySelectorAll('.form-check-input');
            const allChecked = Array.from(allChecks).every(check => check.checked);
            const createBtn = document.getElementById('createDraftBtn');
            
            if (allChecked) {
                createBtn.disabled = false;
                createBtn.innerHTML = '<i class="fas fa-file-alt me-1"></i>إنشاء درافت';
            } else {
                createBtn.disabled = true;
                createBtn.innerHTML = '<i class="fas fa-lock me-1"></i>أكمل التحقق أولاً';
            }
        }

        // Form submission
        document.getElementById('createRequestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (validateCurrentStep()) {
                // Process payment
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                
                if (paymentMethod === 'paytabs') {
                    showSuccess('تم إنشاء الطلب بنجاح! سيتم توجيهك لصفحة الدفع الآمنة...');
                    setTimeout(() => {
                        window.location.href = 'requests.html';
                    }, 2000);
                } else {
                    showSuccess('تم إنشاء الطلب بنجاح!');
                    setTimeout(() => {
                        window.location.href = 'requests.html';
                    }, 2000);
                }
            }
        });
    </script>
    
    <!-- Load Components -->
    <script>
        Promise.all([
            fetch('components/header.html').then(r => r.text()),
            fetch('components/sidebar.html').then(r => r.text()),
            fetch('components/footer.html').then(r => r.text()),
            fetch('components/confirm-modal.html').then(r => r.text())
        ]).then(([header, sidebar, footer, modal]) => {
            document.getElementById('header-placeholder').innerHTML = header;
            document.getElementById('sidebar-placeholder').innerHTML = sidebar;
            document.getElementById('footer-placeholder').innerHTML = footer;
            document.getElementById('modal-placeholder').innerHTML = modal;
        }).catch(error => {
            console.error('خطأ في تحميل المكونات:', error);
        });
    </script>
</body>
</html>
